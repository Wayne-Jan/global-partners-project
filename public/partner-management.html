<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åˆä½œå¤¥ä¼´ç®¡ç†</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50">
    <!-- å°è¦½åˆ— -->
    <nav class="bg-white shadow">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between h-16">
          <div class="flex">
            <a href="/" class="flex items-center text-blue-600 font-bold">
              åœ‹éš›åˆä½œå¤¥ä¼´
            </a>
          </div>
          <div class="flex items-center space-x-4">
            <button
              onclick="location.href='/dashboard.html'"
              class="px-4 py-2 text-gray-600"
            >
              è¿”å›ç®¡ç†é é¢
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 px-4">
      <form id="partnerForm" class="space-y-6">
        <!-- åŸºæœ¬è³‡è¨Š -->
        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-4">åŸºæœ¬è³‡è¨Š</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >åœ‹å®¶</label
              >
              <select
                name="country"
                id="countrySelect"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              >
                <option value="">è«‹é¸æ“‡åœ‹å®¶</option>
                <!-- åœ‹å®¶é¸é …æœƒç”± JavaScript å‹•æ…‹å¡«å…… -->
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >æ©Ÿæ§‹åç¨±</label
              >
              <input
                type="text"
                name="institution"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >éƒ¨é–€åç¨±</label
              >
              <input
                type="text"
                name="department"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >è¨ˆç•«åç¨±</label
              >
              <input
                type="text"
                name="projectName"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
          </div>
        </div>

        <!-- é€²åº¦è³‡è¨Š -->
        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-4">é€²åº¦è³‡è¨Š</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >ç•¶å‰éšæ®µ</label
              >
              <select
                name="phase"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              >
                <option value="åˆæ­¥æ¥è§¸">åˆæ­¥æ¥è§¸</option>
                <option value="ç¢ºèªåˆä½œé …ç›®">ç¢ºèªåˆä½œé …ç›®</option>
                <option value="å ´åœ°å‹˜æŸ¥">å ´åœ°å‹˜æŸ¥</option>
                <option value="è¨­å‚™éƒ¨ç½²">è¨­å‚™éƒ¨ç½²</option>
                <option value="æ•¸æ“šæ”¶é›†">æ•¸æ“šæ”¶é›†</option>
                <option value="åˆ†æèˆ‡å„ªåŒ–">åˆ†æèˆ‡å„ªåŒ–</option>
                <option value="å®Œæˆéšæ®µ">å®Œæˆéšæ®µ</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >é€²åº¦èªªæ˜</label
              >
              <textarea
                name="progressDetails"
                rows="3"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- å ´åœ°è³‡è¨Š -->
        <div class="bg-white shadow rounded-lg p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">å ´åœ°è³‡è¨Š</h2>
            <button
              type="button"
              id="addSiteBtn"
              class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
            >
              æ–°å¢å ´åœ°
            </button>
          </div>
          <div id="sitesContainer" class="space-y-4">
            <!-- å ´åœ°è¡¨å–®æœƒç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>

        <!-- è¯çµ¡äººè³‡è¨Š -->
        <div class="bg-white shadow rounded-lg p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">è¯çµ¡çª—å£</h2>
            <button
              type="button"
              id="addContactBtn"
              class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
            >
              æ–°å¢è¯çµ¡äºº
            </button>
          </div>
          <div id="contactsContainer" class="space-y-4">
            <!-- è¯çµ¡äººè¡¨å–®æœƒç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>

        <!-- å„²å­˜æŒ‰éˆ• -->
        <div class="flex justify-end">
          <button
            type="button"
            onclick="history.back()"
            class="mr-4 px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50"
          >
            å–æ¶ˆ
          </button>
          <button
            type="submit"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            å„²å­˜
          </button>
        </div>
      </form>
    </div>

    <!-- å ´åœ°è¡¨å–®æ¨¡æ¿ -->
    <template id="siteTemplate">
      <div class="site-form border rounded-lg p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >å ´åœ°åç¨±</label
            >
            <input
              type="text"
              name="sites[INDEX][name]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >å ´åœ°é¡å‹</label
            >
            <input
              type="text"
              name="sites[INDEX][type]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">åœ°å€</label>
            <input
              type="text"
              name="sites[INDEX][location]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >ä½¿ç”¨ç‹€æ…‹</label
            >
            <select
              name="sites[INDEX][status]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            >
              <option value="è¦åŠƒä¸­">è¦åŠƒä¸­</option>
              <option value="å»ºç½®ä¸­">å»ºç½®ä¸­</option>
              <option value="ä½¿ç”¨ä¸­">ä½¿ç”¨ä¸­</option>
              <option value="æš«åœä½¿ç”¨">æš«åœä½¿ç”¨</option>
            </select>
          </div>
        </div>
        <button
          type="button"
          class="remove-site mt-4 px-3 py-1 text-red-600 hover:text-red-800"
        >
          åˆªé™¤å ´åœ°
        </button>
      </div>
    </template>

    <!-- è¯çµ¡äººè¡¨å–®æ¨¡æ¿ -->
    <template id="contactTemplate">
      <div class="contact-form border rounded-lg p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">å§“å</label>
            <input
              type="text"
              name="contacts[INDEX][name]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">è·ç¨±</label>
            <input
              type="text"
              name="contacts[INDEX][title]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input
              type="email"
              name="contacts[INDEX][email]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">é›»è©±</label>
            <input
              type="tel"
              name="contacts[INDEX][phone]"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
        </div>
        <button
          type="button"
          class="remove-contact mt-4 px-3 py-1 text-red-600 hover:text-red-800"
        >
          åˆªé™¤è¯çµ¡äºº
        </button>
      </div>
    </template>

    <script>
      let siteCount = 0;
      let contactCount = 0;

      // åœ‹å®¶è³‡æ–™
      const countries = {
        TW: { name: "å°ç£", flag: "ğŸ‡¹ğŸ‡¼" },
        US: { name: "ç¾åœ‹", flag: "ğŸ‡ºğŸ‡¸" },
        JP: { name: "æ—¥æœ¬", flag: "ğŸ‡¯ğŸ‡µ" },
        TH: { name: "æ³°åœ‹", flag: "ğŸ‡¹ğŸ‡­" },
        VN: { name: "è¶Šå—", flag: "ğŸ‡»ğŸ‡³" },
        // ... å…¶ä»–åœ‹å®¶
      };

      // åˆå§‹åŒ–åœ‹å®¶é¸é …
      function initializeCountries() {
        const select = document.getElementById("countrySelect");
        Object.entries(countries).forEach(([code, data]) => {
          const option = document.createElement("option");
          option.value = code;
          option.textContent = `${data.flag} ${data.name}`;
          select.appendChild(option);
        });
      }

      // æ·»åŠ å ´åœ°
      function addSite() {
        const template = document.getElementById("siteTemplate");
        const container = document.getElementById("sitesContainer");
        const clone = template.content.cloneNode(true);

        // æ›´æ–°ç´¢å¼•
        clone.querySelectorAll('[name*="INDEX"]').forEach((input) => {
          input.name = input.name.replace("INDEX", siteCount);
        });

        container.appendChild(clone);
        siteCount++;
      }

      // æ·»åŠ è¯çµ¡äºº
      function addContact() {
        const template = document.getElementById("contactTemplate");
        const container = document.getElementById("contactsContainer");
        const clone = template.content.cloneNode(true);

        // æ›´æ–°ç´¢å¼•
        clone.querySelectorAll('[name*="INDEX"]').forEach((input) => {
          input.name = input.name.replace("INDEX", contactCount);
        });

        container.appendChild(clone);
        contactCount++;
      }

      // è¡¨å–®æäº¤è™•ç†
      async function handleSubmit(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const data = {
          country: {
            code: formData.get("country"),
            name: countries[formData.get("country")]?.name,
            flag: countries[formData.get("country")]?.flag,
          },
          institution: {
            name: formData.get("institution"),
            department: formData.get("department"),
          },
          project: {
            name: formData.get("projectName"),
          },
          progress: {
            phase: formData.get("phase"),
            details: formData.get("progressDetails"),
            lastUpdate: new Date(),
          },
          sites: [],
          contacts: [],
        };

        // åŸºæœ¬è³‡æ–™é©—è­‰
        if (!data.country.code || !data.country.name || !data.country.flag) {
          alert("è«‹é¸æ“‡åœ‹å®¶");
          return;
        }

        if (!data.institution.name) {
          alert("è«‹è¼¸å…¥æ©Ÿæ§‹åç¨±");
          return;
        }

        if (!data.project.name) {
          alert("è«‹è¼¸å…¥è¨ˆç•«åç¨±");
          return;
        }

        if (!data.progress.phase) {
          alert("è«‹é¸æ“‡åŸ·è¡Œéšæ®µ");
          return;
        }

        // æ”¶é›†å ´åœ°è³‡è¨Š
        for (let i = 0; i < siteCount; i++) {
          const siteName = formData.get(`sites[${i}][name]`);
          if (siteName) {
            const site = {
              name: siteName,
              type: formData.get(`sites[${i}][type]`),
              location: formData.get(`sites[${i}][location]`),
              status: formData.get(`sites[${i}][status]`),
            };

            // å ´åœ°è³‡æ–™é©—è­‰
            if (!site.type || !site.location || !site.status) {
              alert(`è«‹å®Œæ•´å¡«å¯«å ´åœ° "${siteName}" çš„æ‰€æœ‰å¿…å¡«è³‡è¨Š`);
              return;
            }

            data.sites.push(site);
          }
        }

        // æ”¶é›†è¯çµ¡äººè³‡è¨Š
        for (let i = 0; i < contactCount; i++) {
          const contactName = formData.get(`contacts[${i}][name]`);
          if (contactName) {
            const contact = {
              name: contactName,
              title: formData.get(`contacts[${i}][title]`),
              email: formData.get(`contacts[${i}][email]`),
              phone: formData.get(`contacts[${i}][phone]`),
            };

            // è¯çµ¡äººè³‡æ–™é©—è­‰
            if (!contact.title || !contact.email) {
              alert(`è«‹å®Œæ•´å¡«å¯«è¯çµ¡äºº "${contactName}" çš„æ‰€æœ‰å¿…å¡«è³‡è¨Š`);
              return;
            }

            // Email æ ¼å¼é©—è­‰
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(contact.email)) {
              alert(`è¯çµ¡äºº "${contactName}" çš„ Email æ ¼å¼ä¸æ­£ç¢º`);
              return;
            }

            data.contacts.push(contact);
          }
        }

        try {
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("æœªç™»å…¥ç‹€æ…‹");
          }

          const response = await fetch("/api/partners", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(data),
          });

          // é™¤éŒ¯æ—¥èªŒ
          const responseData = await response.json();

          if (!response.ok) {
            throw new Error(responseData.message || "å„²å­˜å¤±æ•—");
          }

          // å„²å­˜æˆåŠŸ
          alert("å„²å­˜æˆåŠŸï¼");
          window.location.href = "/partners.html";
        } catch (error) {
          console.error("Error details:", error);
          alert(`å„²å­˜å¤±æ•—: ${error.message}`);
        }
      }

      // äº‹ä»¶ç›£è½å™¨è¨­ç½®
      function setupEventListeners() {
        // åˆªé™¤å ´åœ°/è¯çµ¡äººçš„äº‹ä»¶ç›£è½
        document.addEventListener("click", (event) => {
          if (event.target.classList.contains("remove-site")) {
            event.target.closest(".site-form").remove();
          } else if (event.target.classList.contains("remove-contact")) {
            event.target.closest(".contact-form").remove();
          }
        });

        // è¡¨å–®æäº¤çš„äº‹ä»¶ç›£è½
        document
          .getElementById("partnerForm")
          .addEventListener("submit", handleSubmit);
      }

      // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", setupEventListeners);

      // è¼‰å…¥ç¾æœ‰è³‡æ–™ï¼ˆå¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼‰
      async function loadExistingData() {
        const urlParams = new URLSearchParams(window.location.search);
        const partnerId = urlParams.get("id");

        if (partnerId) {
          try {
            const response = await fetch(`/api/partners/${partnerId}`, {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            });

            if (response.ok) {
              const data = await response.json();
              populateForm(data);
            } else {
              throw new Error("ç„¡æ³•è¼‰å…¥è³‡æ–™");
            }
          } catch (error) {
            alert(`è¼‰å…¥å¤±æ•—: ${error.message}`);
          }
        }
      }

      // å¡«å……è¡¨å–®è³‡æ–™
      function populateForm(data) {
        // åŸºæœ¬è³‡è¨Š
        document.querySelector('[name="country"]').value = data.country.code;
        document.querySelector('[name="institution"]').value =
          data.institution.name;
        document.querySelector('[name="department"]').value =
          data.institution.department || "";
        document.querySelector('[name="projectName"]').value =
          data.project.name;

        // é€²åº¦è³‡è¨Š
        document.querySelector('[name="phase"]').value = data.progress.phase;
        document.querySelector('[name="progressDetails"]').value =
          data.progress.details || "";

        // å ´åœ°è³‡è¨Š
        data.sites.forEach((site) => {
          addSite();
          const lastIndex = siteCount - 1;
          document.querySelector(`[name="sites[${lastIndex}][name]"]`).value =
            site.name;
          document.querySelector(`[name="sites[${lastIndex}][type]"]`).value =
            site.type;
          document.querySelector(
            `[name="sites[${lastIndex}][location]"]`
          ).value = site.location;
          document.querySelector(`[name="sites[${lastIndex}][status]"]`).value =
            site.status;
        });

        // è¯çµ¡äººè³‡è¨Š
        data.contacts.forEach((contact) => {
          addContact();
          const lastIndex = contactCount - 1;
          document.querySelector(
            `[name="contacts[${lastIndex}][name]"]`
          ).value = contact.name;
          document.querySelector(
            `[name="contacts[${lastIndex}][title]"]`
          ).value = contact.title;
          document.querySelector(
            `[name="contacts[${lastIndex}][email]"]`
          ).value = contact.email;
          document.querySelector(
            `[name="contacts[${lastIndex}][phone]"]`
          ).value = contact.phone || "";
        });
      }

      // æ¬Šé™æª¢æŸ¥
      function checkPermissions() {
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        if (user.role !== "admin") {
          window.location.href = "/partners.html";
        }
      }

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", () => {
        checkPermissions();
        initializeCountries();
        loadExistingData();

        // äº‹ä»¶ç›£è½
        document
          .getElementById("addSiteBtn")
          .addEventListener("click", addSite);
        document
          .getElementById("addContactBtn")
          .addEventListener("click", addContact);
        document
          .getElementById("partnerForm")
          .addEventListener("submit", handleSubmit);
      });
    </script>
  </body>
</html>
