<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>合作夥伴詳細資訊</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background-color: #f5f5f5;
        padding: 0;
      }

      .nav-container {
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        margin-bottom: 20px;
      }

      .nav-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-logo {
        font-size: 1.25rem;
        font-weight: bold;
        color: #2563eb;
        text-decoration: none;
      }

      .nav-links {
        display: flex;
        gap: 1rem;
      }

      .nav-item {
        color: #4b5563;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
        cursor: pointer;
      }

      .nav-item:hover {
        background-color: #f3f4f6;
      }

      .nav-item.edit {
        background-color: #2563eb;
        color: white;
      }

      .nav-item.edit:hover {
        background-color: #1d4ed8;
      }

      /* 新的時間軸樣式 */
      .timeline-container {
        position: relative;
        padding-left: 32px;
        margin-top: 24px;
      }

      .timeline-line {
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #e5e7eb;
      }

      .timeline-dot {
        position: absolute;
        left: 11px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #3b82f6;
        border: 2px solid #fff;
        box-shadow: 0 0 0 2px #3b82f6;
        z-index: 1;
      }

      .timeline-item {
        position: relative;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid #e5e7eb;
        transition: all 0.3s ease;
      }

      .timeline-item:hover {
        background-color: #f8fafc;
        border-radius: 8px;
        padding: 12px;
        margin-left: -12px;
      }

      .timeline-content {
        background-color: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-left: 12px;
      }

      .timeline-date {
        color: #6b7280;
        font-size: 0.875rem;
        margin-bottom: 4px;
      }

      .timeline-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .timeline-description {
        color: #4b5563;
        font-size: 0.875rem;
        line-height: 1.5;
      }

      .timeline-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        margin-left: 8px;
      }

      .badge-update {
        background-color: #dbeafe;
        color: #1e40af;
      }

      .badge-create {
        background-color: #dcfce7;
        color: #166534;
      }

      .badge-delete {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .timeline-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .add-button-container {
        position: relative;
        text-align: center;
        margin: 1rem 0;
        padding: 1rem 0;
      }

      .add-button-container::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: 1px;
        background-color: #e5e7eb;
        z-index: 1;
      }

      .add-button {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        margin: 0 auto;
        background-color: white;
        border: 2px solid #e5e7eb;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 2;
      }

      .add-button:hover {
        background-color: #2563eb;
        border-color: #2563eb;
        transform: scale(1.1);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .add-button svg {
        width: 16px;
        height: 16px;
        fill: #2563eb;
        transition: fill 0.3s ease;
      }

      .add-button:hover svg {
        fill: white;
      }

      .add-button-label {
        position: absolute;
        left: 50%;
        bottom: -24px;
        transform: translateX(-50%);
        font-size: 0.875rem;
        color: #6b7280;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .add-button:hover + .add-button-label {
        opacity: 1;
      }
    </style>
  </head>

  <!-- Body 部分保持不變 -->
  <body class="bg-gray-50">
    <!-- 導覽列 -->
    <nav class="nav-container">
      <div class="nav-content">
        <a href="/" class="nav-logo">國際合作夥伴</a>
        <div class="nav-links" id="navButtons">
          <!-- 權限按鈕將由 JavaScript 動態添加 -->
        </div>
      </div>
    </nav>

    <!-- 主要內容區 -->
    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
      <!-- 基本資訊卡片 -->
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6">
          <div id="basicInfo" class="mb-6">
            <!-- 基本資訊將由 JavaScript 動態填充 -->
          </div>
          <div id="progressInfo" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 進度資訊將由 JavaScript 動態填充 -->
          </div>
        </div>
      </div>

      <!-- 詳細資訊區塊 -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- 時間軸 保持不變 -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4">進度時間軸</h2>
          <div id="timelineContainer" class="timeline-container">
            <div class="timeline-line"></div>
            <!-- 時間軸項目將由 JavaScript 動態填充 -->
          </div>
          <div class="add-button-container">
            <button class="add-button" onclick="addTimelineItem()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                  d="M12 4a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5a1 1 0 0 1 1-1z"
                />
              </svg>
            </button>
            <span class="add-button-label">新增時間軸項目</span>
          </div>
        </div>

        <!-- 相關資料 (替換原本的場地資訊) -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4">相關資料</h2>
          <div id="resourcesContainer" class="space-y-4">
            <!-- 資源內容將由 JavaScript 動態填充 -->
          </div>
          <!-- 相關資料項目之後的新增按鈕 -->
          <div class="add-button-container">
            <button class="add-button" onclick="addResourceItem()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                  d="M12 4a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5a1 1 0 0 1 1-1z"
                />
              </svg>
            </button>
            <span class="add-button-label">新增相關資料</span>
          </div>
        </div>
      </div>

      <!-- 聯絡人資訊 -->
      <div class="bg-white rounded-lg shadow mt-6 p-6">
        <h2 class="text-xl font-semibold mb-4">聯絡窗口</h2>
        <div
          id="contactsContainer"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        >
          <!-- 聯絡人資訊將由 JavaScript 動態填充 -->
        </div>
      </div>
    </div>

    <script>
      // 檢查用戶權限
      function checkPermissions() {
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const navButtons = document.getElementById("navButtons");

        let navHTML = `
    <a href="/partners.html" class="nav-item">
      返回列表
    </a>
  `;

        const hasPermission =
          user.role === "admin" ||
          (user.assignedCountries || []).includes(
            window.partnerData?.country?.code
          );

        if (hasPermission && window.partnerData?._id) {
          navHTML += `
      <a href="/partner-management.html?id=${window.partnerData._id}"
         class="nav-item edit ml-4">
        編輯資料
      </a>
    `;
        }

        navButtons.innerHTML = navHTML;
      }

      // 載入合作夥伴資料
      async function loadPartnerData() {
        const urlParams = new URLSearchParams(window.location.search);
        const partnerId = urlParams.get("id");

        if (!partnerId) {
          window.location.href = "/partners.html";
          return;
        }

        try {
          const token = localStorage.getItem("token");
          const response = await fetch(`/api/partners/${partnerId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          window.partnerData = data;
          updateUI(data);
          checkPermissions();
        } catch (error) {
          console.error("Error loading partner data:", error);
        }
      }

      // 更新 UI
      function updateUI(data) {
        // 更新基本資訊
        document.getElementById("basicInfo").innerHTML = `
    <div class="relative">
      <div class="absolute top-0 left-0 bg-blue-100 text-blue-800 px-3 py-1 rounded-bl-lg rounded-tr-lg text-sm font-medium">
        ${data.project.name}
      </div>
      <div class="flex items-center space-x-4 pt-8">
        <span class="text-4xl">${data.country.flag}</span>
        <h1 class="text-2xl font-bold">${data.country.name}</h1>
      </div>
      <div class="mt-4">
        <h2 class="text-xl text-blue-600 font-semibold">${
          data.institution.name
        }</h2>
        ${
          data.institution.department
            ? `<p class="text-gray-600 mt-1">${data.institution.department}</p>`
            : ""
        }
      </div>
    </div>
  `;

        // 更新進度資訊
        document.getElementById("progressInfo").innerHTML = `
    <div>
      <h3 class="font-medium text-gray-700">當前階段</h3>
      <p class="mt-1 text-lg">${data.progress.phase}</p>
    </div>
    <div>
      <h3 class="font-medium text-gray-700">最後更新</h3>
      <p class="mt-1">${new Date(
        data.progress.lastUpdate
      ).toLocaleDateString()}</p>
    </div>
  `;

        // 檢查用戶是否為管理員
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const isAdmin = user.role === "admin";

        // 更新時間軸
        const timelineHTML = data.timeline
          .map(
            (item) => `
        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div class="timeline-content">
            <div class="timeline-title">
              ${item.event}
              <div class="flex items-center">
                <span class="timeline-badge badge-${
                  item.type || "update"
                }">${getTimelineBadgeText(item.type)}</span>
                ${
                  isAdmin
                    ? `
                  <button
                    onclick="editTimelineEvent('${item._id}', ${JSON.stringify(
                        item
                      ).replace(/"/g, "&quot;")})"
                    class="ml-2 text-blue-600 hover:text-blue-800 text-sm"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                  </button>
                  <button
                    onclick="deleteTimelineEvent('${item._id}')"
                    class="ml-2 text-red-600 hover:text-red-800 text-sm"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                `
                    : ""
                }
              </div>
            </div>
            <div class="timeline-date">${new Date(item.date).toLocaleString(
              "zh-TW"
            )}</div>
            <div class="timeline-description">${item.description}</div>
          </div>
        </div>
      `
          )
          .join("");

        const timelineContainer = document.getElementById("timelineContainer");
        timelineContainer.innerHTML = `
    <div class="timeline-line"></div>
    ${timelineHTML}
  `;

        // 更新資源區塊
        const resourcesHTML = (data.resources || [])
          .sort((a, b) => a.order - b.order)
          .map(
            (resource) => `
        <div class="border rounded-lg p-4 mb-4">
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-medium text-lg">${resource.title}</h3>
            <div class="flex items-center">
              <span class="text-sm text-gray-500 mr-4">
                ${new Date(resource.createdAt).toLocaleString("zh-TW")}
              </span>
              ${
                isAdmin
                  ? `
                <button
                  onclick="editResource('${resource._id}', ${JSON.stringify(
                      resource
                    ).replace(/"/g, "&quot;")})"
                  class="ml-2 text-blue-600 hover:text-blue-800 text-sm"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                  </svg>
                </button>
                <button
                  onclick="deleteResource('${resource._id}')"
                  class="ml-2 text-red-600 hover:text-red-800 text-sm"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              `
                  : ""
              }
            </div>
          </div>
          <div class="prose max-w-none">
            ${
              resource.type === "link"
                ? `<a href="${resource.url}" target="_blank" class="text-blue-600 hover:underline">${resource.content}</a>`
                : `<p class="whitespace-pre-wrap">${resource.content}</p>`
            }
          </div>
          ${
            resource.url && resource.type !== "link"
              ? `<div class="mt-2">
                <a href="${resource.url}" target="_blank" class="text-sm text-blue-600 hover:underline">相關連結</a>
               </div>`
              : ""
          }
        </div>
      `
          )
          .join("");

        document.getElementById("resourcesContainer").innerHTML =
          resourcesHTML ||
          '<p class="text-gray-500 text-center">尚無相關資料</p>';

        // 更新聯絡人資訊
        const contactsHTML = data.contacts
          .map(
            (contact) => `
        <div class="border rounded-lg p-4">
          <h3 class="font-medium">${contact.name}</h3>
          <p class="text-gray-600 text-sm mt-1">${contact.title}</p>
          <div class="mt-2 space-y-1">
            <p class="text-sm">
              <span class="text-gray-500">Email:</span>
              <a href="mailto:${contact.email}" class="text-blue-600">${
              contact.email
            }</a>
            </p>
            ${
              contact.phone
                ? `
                <p class="text-sm">
                  <span class="text-gray-500">電話:</span>
                  <a href="tel:${contact.phone}" class="text-blue-600">${contact.phone}</a>
                </p>
              `
                : ""
            }
          </div>
        </div>
      `
          )
          .join("");
        document.getElementById("contactsContainer").innerHTML = contactsHTML;
      }

      // 輔助函數：獲取時間軸徽章文字
      function getTimelineBadgeText(type) {
        const badgeTexts = {
          create: "新增",
          update: "更新",
          delete: "刪除",
        };
        return badgeTexts[type] || "更新";
      }

      // 在 DOMContentLoaded 時添加模態框
      document.addEventListener("DOMContentLoaded", () => {
        // 添加時間軸編輯模態框 HTML
        document.body.insertAdjacentHTML(
          "beforeend",
          `
    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">編輯時間軸事件</h3>
          <form id="editTimelineForm">
            <input type="hidden" id="eventId">
            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2" for="event">
                事件標題
              </label>
              <input
                type="text"
                id="event"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                required
              >
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2" for="phase">
                執行階段
              </label>
              <select
                id="phase"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                required
              >
                <option value="初步接觸">初步接觸</option>
                <option value="確認合作項目">確認合作項目</option>
                <option value="場地勘查">場地勘查</option>
                <option value="設備部署">設備部署</option>
                <option value="數據收集">數據收集</option>
                <option value="分析與優化">分析與優化</option>
                <option value="完成階段">完成階段</option>
              </select>
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2" for="date">
                日期時間
              </label>
              <input
                type="datetime-local"
                id="date"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                required
              >
            </div>
            <div class="mb-6">
              <label class="block text-gray-700 text-sm font-bold mb-2" for="description">
                描述
              </label>
              <textarea
                id="description"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                rows="3"
                required
              ></textarea>
            </div>
            <div class="flex items-center justify-between">
              <button
                type="submit"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
              >
                儲存
              </button>
              <button
                type="button"
                onclick="closeEditModal()"
                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
              >
                取消
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 資源編輯模態框 -->
    <div id="resourceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">編輯資源</h3>
          <form id="editResourceForm">
            <input type="hidden" id="resourceId">
            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2" for="title">
                標題
              </label>
              <input
                type="text"
                id="resourceTitle"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                required
              >
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2" for="resourceType">
                類型
              </label>
              <select
                id="resourceType"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                required
              >
                <option value="text">文字</option>
                <option value="link">連結</option>
              </select>
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2" for="content">
                內容
              </label>
              <textarea
                id="resourceContent"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                rows="3"
                required
              ></textarea>
            </div>
            <div class="mb-6">
              <label class="block text-gray-700 text-sm font-bold mb-2" for="url">
                相關連結（選填）
              </label>
              <input
                type="url"
                id="resourceUrl"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              >
            </div>
            <div class="flex items-center justify-between">
              <button
                type="submit"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
              >
                儲存
              </button>
              <button
                type="button"
                onclick="closeResourceModal()"
                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
              >
                取消
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `
        );

        // 添加點擊模態框外部關閉的功能
        document.getElementById("editModal").addEventListener("click", (e) => {
          if (e.target.id === "editModal") {
            closeEditModal();
          }
        });

        document
          .getElementById("resourceModal")
          .addEventListener("click", (e) => {
            if (e.target.id === "resourceModal") {
              closeResourceModal();
            }
          });

        // 初始化頁面數據
        loadPartnerData();
      });

      // 時間軸相關函數
      async function deleteTimelineEvent(eventId) {
        if (!confirm("確定要刪除此事件嗎？")) {
          return;
        }

        const token = localStorage.getItem("token");
        const partnerId = window.partnerData._id;

        try {
          const response = await fetch(
            `/api/partners/${partnerId}/timeline/${eventId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          await loadPartnerData();
        } catch (error) {
          console.error("Error deleting timeline event:", error);
          alert("刪除事件時發生錯誤");
        }
      }

      function editTimelineEvent(eventId, eventData) {
        const modal = document.getElementById("editModal");
        const form = document.getElementById("editTimelineForm");

        document.getElementById("eventId").value = eventId;
        document.getElementById("event").value = eventData.event;
        document.getElementById("description").value = eventData.description;
        document.getElementById("phase").value = eventData.phase || "初步接觸";

        const date = new Date(eventData.date);
        const formattedDate = date.toISOString().slice(0, 16);
        document.getElementById("date").value = formattedDate;

        modal.classList.remove("hidden");

        form.onsubmit = async (e) => {
          e.preventDefault();
          await updateTimelineEvent();
        };
      }

      function closeEditModal() {
        const modal = document.getElementById("editModal");
        modal.classList.add("hidden");
      }

      async function updateTimelineEvent() {
        const eventId = document.getElementById("eventId").value;
        const partnerId = window.partnerData._id;
        const token = localStorage.getItem("token");

        const originalEvent = window.partnerData.timeline.find(
          (event) => event._id === eventId
        );

        const updatedData = {
          event: document.getElementById("event").value,
          description: document.getElementById("description").value,
          phase: document.getElementById("phase").value,
          date: new Date(document.getElementById("date").value).toISOString(),
          type: originalEvent.type,
        };

        try {
          const response = await fetch(
            `/api/partners/${partnerId}/timeline/${eventId}`,
            {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(updatedData),
            }
          );

          if (!response.ok) {
            const errorText = await response.text();
            console.error("Server response:", errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          closeEditModal();
          await loadPartnerData();
        } catch (error) {
          console.error("Error updating timeline event:", error);
          alert("更新事件時發生錯誤：" + error.message);
        }
      }

      // 資源相關函數
      async function deleteResource(resourceId) {
        if (!confirm("確定要刪除此資源嗎？")) {
          return;
        }

        const token = localStorage.getItem("token");
        const partnerId = window.partnerData._id;

        try {
          const updatedResources = window.partnerData.resources.filter(
            (resource) => resource._id !== resourceId
          );

          const response = await fetch(`/api/partners/${partnerId}`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ...window.partnerData,
              resources: updatedResources,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          await loadPartnerData();
        } catch (error) {
          console.error("Error deleting resource:", error);
          alert("刪除資源時發生錯誤");
        }
      }

      function editResource(resourceId, resourceData) {
        const modal = document.getElementById("resourceModal");
        const form = document.getElementById("editResourceForm");

        document.getElementById("resourceId").value = resourceId;
        document.getElementById("resourceTitle").value = resourceData.title;
        document.getElementById("resourceType").value = resourceData.type;
        document.getElementById("resourceContent").value = resourceData.content;
        document.getElementById("resourceUrl").value = resourceData.url || "";

        modal.classList.remove("hidden");

        form.onsubmit = async (e) => {
          e.preventDefault();
          await updateResource();
        };
      }

      function closeResourceModal() {
        const modal = document.getElementById("resourceModal");
        modal.classList.add("hidden");
      }

      async function updateResource() {
        const resourceId = document.getElementById("resourceId").value;
        const partnerId = window.partnerData._id;
        const token = localStorage.getItem("token");

        const updatedResource = {
          _id: resourceId,
          title: document.getElementById("resourceTitle").value,
          type: document.getElementById("resourceType").value,
          content: document.getElementById("resourceContent").value,
          url: document.getElementById("resourceUrl").value,
          createdAt: new Date().toISOString(),
          order:
            window.partnerData.resources.find((r) => r._id === resourceId)
              ?.order || 0,
        };

        const updatedResources = window.partnerData.resources.map((resource) =>
          resource._id === resourceId ? updatedResource : resource
        );

        try {
          const response = await fetch(`/api/partners/${partnerId}`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ...window.partnerData,
              resources: updatedResources,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          closeResourceModal();
          await loadPartnerData();
        } catch (error) {
          console.error("Error updating resource:", error);
          alert("更新資源時發生錯誤：" + error.message);
        }
      }

      async function addTimelineItem() {
        // 打開模態框
        editTimelineEvent(null, {
          event: "",
          description: "",
          phase: "初步接觸",
          date: new Date().toISOString(),
        });

        // 修改表單提交處理
        const form = document.getElementById("editTimelineForm");
        form.onsubmit = async (e) => {
          e.preventDefault();
          const partnerId = window.partnerData._id;
          const token = localStorage.getItem("token");

          const newData = {
            event: document.getElementById("event").value,
            description: document.getElementById("description").value,
            phase: document.getElementById("phase").value,
            date: new Date(document.getElementById("date").value).toISOString(),
          };

          try {
            const response = await fetch(
              `/api/partners/${partnerId}/timeline`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(newData),
              }
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            closeEditModal();
            await loadPartnerData();
          } catch (error) {
            console.error("Error adding timeline event:", error);
            alert("新增事件時發生錯誤：" + error.message);
          }
        };
      }

      async function addResourceItem() {
        // 打開模態框
        editResource(null, {
          title: "",
          type: "text",
          content: "",
          url: "",
        });

        // 修改表單提交處理
        const form = document.getElementById("editResourceForm");
        form.onsubmit = async (e) => {
          e.preventDefault();
          const partnerId = window.partnerData._id;
          const token = localStorage.getItem("token");

          const newResource = {
            title: document.getElementById("resourceTitle").value,
            type: document.getElementById("resourceType").value,
            content: document.getElementById("resourceContent").value,
            url: document.getElementById("resourceUrl").value,
          };

          try {
            const response = await fetch(
              `/api/partners/${partnerId}/resources`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(newResource),
              }
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            closeResourceModal();
            await loadPartnerData();
          } catch (error) {
            console.error("Error adding resource:", error);
            alert("新增資源時發生錯誤：" + error.message);
          }
        };
      }
    </script>
  </body>
</html>
