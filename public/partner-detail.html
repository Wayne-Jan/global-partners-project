<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>合作夥伴詳細資訊</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      /* 基本樣式重置 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background-color: #f5f5f5;
        padding: 0;
      }

      /* 導覽列樣式 */
      .nav-container {
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        margin-bottom: 20px;
        position: relative;
      }

      .nav-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-logo {
        font-size: 1.25rem;
        font-weight: bold;
        color: #2563eb;
        text-decoration: none;
      }

      .nav-links {
        display: flex;
        gap: 1rem;
      }

      .nav-item {
        color: #4b5563;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
        cursor: pointer;
      }

      .nav-item:hover {
        background-color: #f3f4f6;
      }

      .nav-item.edit {
        background-color: #2563eb;
        color: white;
      }

      .nav-item.edit:hover {
        background-color: #1d4ed8;
      }

      /* 時間軸樣式 */
      .timeline-container {
        position: relative;
        padding-left: 32px;
        margin-top: 24px;
        padding-top: 12px; /* 增加頂部間距 */
        overflow-x: hidden; /* 防止橫向捲動 */
      }

      .timeline-line {
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #e5e7eb;
      }

      .timeline-dot {
        position: absolute;
        left: 11px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #3b82f6; /* 預設藍色 */
        border: 2px solid #fff;
        box-shadow: 0 0 0 2px #3b82f6; /* 預設藍色陰影 */
        z-index: 1;
      }

      /* 不同類型的時間軸點點顏色 */
      .timeline-dot.create {
        background-color: #10b981; /* 綠色 */
        box-shadow: 0 0 0 2px #10b981;
      }

      .timeline-dot.update {
        background-color: #3b82f6; /* 藍色 */
        box-shadow: 0 0 0 2px #3b82f6;
      }

      .timeline-dot.delete {
        background-color: #ef4444; /* 紅色 */
        box-shadow: 0 0 0 2px #ef4444;
      }

      .timeline-dot.contact {
        background-color: #8b5cf6; /* 紫色 */
        box-shadow: 0 0 0 2px #8b5cf6;
      }

      .timeline-dot.phase {
        background-color: #f59e0b; /* 橙色 */
        box-shadow: 0 0 0 2px #f59e0b;
      }

      .timeline-item {
        position: relative;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid #e5e7eb;
        transition: all 0.3s ease;
        cursor: pointer; /* 確保 cursor 為指針 */
      }

      .timeline-item:hover {
        background-color: #f8fafc;
        border-radius: 8px;
        padding: 12px;
        margin-left: -12px;
      }

      .timeline-content {
        background-color: #ffffff; /* 白色背景 */
        border-left: 4px solid transparent; /* 初始為透明 */
        transition: border-color 0.3s ease, background-color 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-left: 12px;
        padding: 16px;
        border-radius: 8px;
      }

      /* 根據類型調整左側邊框顏色 */
      .timeline-item.create .timeline-content {
        border-color: #10b981; /* 綠色 */
      }

      .timeline-item.update .timeline-content {
        border-color: #3b82f6; /* 藍色 */
      }

      .timeline-item.delete .timeline-content {
        border-color: #ef4444; /* 紅色 */
      }

      .timeline-item.contact .timeline-content {
        border-color: #8b5cf6; /* 紫色 */
      }

      .timeline-item.phase .timeline-content {
        border-color: #f59e0b; /* 橙色 */
      }

      .timeline-date {
        color: #6b7280;
        font-size: 0.875rem;
        margin-bottom: 4px;
      }

      .timeline-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .timeline-description {
        color: #4b5563;
        font-size: 0.875rem;
        line-height: 1.5;
      }

      .timeline-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        margin-left: 8px;
        color: white; /* 確保文字為白色 */
      }

      /* 不同類型的徽章顏色 */
      .badge-update {
        background-color: #3b82f6; /* 藍色 */
      }

      .badge-create {
        background-color: #10b981; /* 綠色 */
      }

      .badge-delete {
        background-color: #ef4444; /* 紅色 */
      }

      .badge-contact {
        background-color: #8b5cf6; /* 紫色 */
      }

      .badge-phase {
        background-color: #f59e0b; /* 橙色 */
      }

      .timeline-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .add-button-container {
        position: relative;
        text-align: center;
        margin: 1rem 0;
        padding: 1rem 0;
      }

      .add-button-container::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: 1px;
        background-color: #e5e7eb;
        z-index: 1;
      }

      .add-button {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px; /* 增大按鈕尺寸以提升可視性 */
        height: 40px;
        margin: 0 auto;
        background-color: #e5e7eb; /* Tailwind CSS 的灰色 300 */
        border: 1px solid #e5e7eb; /* Tailwind CSS 的灰色 400 */
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 2;
      }

      .add-button:hover {
        background-color: #2563eb; /* Tailwind CSS 的藍色 600 */
        border-color: #2563eb;
        transform: scale(1.1);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .add-button svg {
        width: 20px; /* 增大加號圖示尺寸 */
        height: 20px;
        fill: #e7e7e7; /* Tailwind CSS 的灰色 700 */
        transition: fill 0.3s ease;
      }

      .add-button:hover svg {
        fill: white;
      }

      .add-button-label {
        position: absolute;
        left: 50%;
        bottom: -24px;
        transform: translateX(-50%);
        font-size: 0.875rem;
        color: #e7e7e7;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .add-button:hover + .add-button-label {
        opacity: 1;
      }

      /* 新增的切換按鈕樣式 */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #2563eb;
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      /* 確保按鈕不觸發父元素的點擊事件 */
      .timeline-item button {
        cursor: pointer;
      }

      /* 新增的CSS */
      .prose {
        line-height: 1.75;
      }

      .prose p {
        margin-bottom: 1em;
      }

      /* 漸變背景效果 */
      .bg-gradient {
        background: linear-gradient(to right, #f8fafc, #f1f5f9);
      }

      /* 卡片懸浮效果 */
      .shadow-sm {
        transition: all 0.3s ease;
      }

      .shadow-sm:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      /* 移除基本資訊的懸停效果 */
      #basicInfoCard:hover {
        /* 無任何效果 */
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      /* 漢堡選單按鈕樣式 */
      .hamburger {
        display: none;
        width: 32px;
        height: 32px;
        position: relative;
        cursor: pointer;
        background: transparent;
        border: none;
        padding: 0;
        border-radius: 4px;
        transition: background-color 0.3s;
      }

      .hamburger:hover {
        background-color: rgba(37, 99, 235, 0.1);
      }

      .hamburger div {
        position: absolute;
        width: 18px;
        height: 2px;
        background-color: #2563eb;
        left: 7px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .hamburger .line1 {
        top: 11px;
      }

      .hamburger .line2 {
        top: 15px;
      }

      .hamburger .line3 {
        top: 19px;
      }

      /* 漢堡選單開啟時的動畫效果 */
      .hamburger.active .line1 {
        transform: translateY(4px) rotate(45deg);
        background-color: #2563eb;
      }

      .hamburger.active .line2 {
        opacity: 0;
      }

      .hamburger.active .line3 {
        transform: translateY(-4px) rotate(-45deg);
        background-color: #2563eb;
      }

      /* 導覽列下拉選單樣式 */
      @media (max-width: 768px) {
        .nav-links {
          display: none;
          flex-direction: column;
          background-color: white;
          position: absolute;
          top: 100%;
          left: 0;
          width: 100%;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.3s ease-in-out,
            opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          z-index: 1000;
          opacity: 0;
          visibility: hidden;
          transform: translateY(-10px);
        }

        .nav-links.show {
          display: flex;
          max-height: 500px;
          opacity: 1;
          visibility: visible;
          transform: translateY(0);
        }

        .nav-item {
          display: block;
          width: 100%;
          padding: 0.75rem 1rem;
          margin: 0.25rem 0;
          border-radius: 6px;
          color: #4b5563;
          font-weight: 500;
          transition: all 0.2s;
          text-align: left;
        }

        .nav-item:hover {
          background-color: rgba(37, 99, 235, 0.1);
          color: #2563eb;
        }

        .hamburger {
          display: block;
        }
      }

      /* 階段標籤的基本樣式 */
      .phase-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid;
      }

      /* 各個階段的顏色樣式 */
      .phase-initial {
        background-color: #f3e8ff; /* 淺紫色背景 */
        color: #7c3aed; /* 深紫色文字 */
        border-color: #ddd6fe;
      }

      .phase-confirm {
        background-color: #dbeafe; /* 淺藍色背景 */
        color: #2563eb; /* 深藍色文字 */
        border-color: #bfdbfe;
      }

      .phase-survey {
        background-color: #fef9c3; /* 淺黃色背景 */
        color: #d97706; /* 深黃色文字 */
        border-color: #fde68a;
      }

      .phase-deploy {
        background-color: #ffedd5; /* 淺橙色背景 */
        color: #ea580c; /* 深橙色文字 */
        border-color: #fed7aa;
      }

      .phase-collect {
        background-color: #dcfce7; /* 淺綠色背景 */
        color: #16a34a; /* 深綠色文字 */
        border-color: #bbf7d0;
      }

      .phase-analyze {
        background-color: #ede9fe; /* 淺靛藍色背景 */
        color: #6d28d9; /* 深靛藍色文字 */
        border-color: #ddd6fe;
      }

      .phase-complete {
        background-color: #f3f4f6; /* 淺灰色背景 */
        color: #4b5563; /* 深灰色文字 */
        border-color: #e5e7eb;
      }

      /* 調整卡片和內容的最大寬度以適應小屏幕 */
      @media (max-width: 640px) {
        .timeline-container {
          padding-left: 16px;
        }

        .timeline-dot {
          left: 8px;
        }

        .timeline-line {
          left: 12px;
        }

        .timeline-content {
          margin-left: 8px;
          padding: 12px;
        }

        .add-button {
          width: 36px;
          height: 36px;
        }

        .add-button svg {
          width: 18px;
          height: 18px;
        }

        /* 調整基本資訊卡片的內部排版 */
        #basicInfo {
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }

        /* 調整聯絡人資訊區塊 */
        #contactsContainer {
          grid-template-columns: 1fr;
        }
      }

      /* 調整時間軸內容在小屏幕上的顯示 */
      @media (max-width: 640px) {
        .timeline-content {
          padding: 12px;
        }
      }

      /* 調整資源區塊內容在小屏幕上的顯示 */
      @media (max-width: 640px) {
        .resources-content {
          padding: 12px;
        }
      }
    </style>
  </head>

  <!-- Body 部分 -->
  <body class="bg-gray-50">
    <!-- 導覽列 -->
    <nav class="nav-container">
      <div class="nav-content">
        <a href="/" class="flex-shrink-0 flex items-center">
          <span class="nav-logo">國際合作夥伴</span>
        </a>
        <div class="nav-links" id="navLinks">
          <div class="ml-4 flex items-center" id="navButtons">
            <!-- 權限按鈕將由 JavaScript 動態添加 -->
          </div>
        </div>
        <!-- 漢堡選單按鈕 -->
        <button
          class="hamburger md:hidden"
          id="hamburger"
          aria-label="導航選單"
          aria-expanded="false"
          aria-controls="navLinks"
        >
          <div class="line1"></div>
          <div class="line2"></div>
          <div class="line3"></div>
        </button>
      </div>
    </nav>

    <!-- 主要內容區 -->
    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
      <!-- 基本資訊卡片 -->
      <div id="basicInfoCard" class="bg-white rounded-lg shadow-sm mb-6">
        <div class="p-6">
          <div id="basicInfo" class="mb-6">
            <!-- 基本資訊將由 JavaScript 動態填充 -->
          </div>
          <!-- 編輯按鈕，僅在有權限時顯示 -->
          <div id="basicInfoEditButton" class="flex justify-end">
            <!-- 編輯按鈕將由 JavaScript 動態添加 -->
          </div>
        </div>
      </div>

      <!-- 詳細資訊區塊 -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- 時間軸 -->
        <div class="bg-white rounded-lg shadow p-6">
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-4 sm:space-y-0 sm:space-x-6"
          >
            <h2 class="text-xl font-semibold">進度時間軸</h2>
            <label class="flex items-center cursor-pointer">
              <span class="mr-2 text-sm text-gray-700">倒序排列</span>
              <div class="toggle-switch">
                <input
                  type="checkbox"
                  id="reverseOrderToggle"
                  class="sr-only"
                  checked
                />
                <span class="slider"></span>
              </div>
            </label>
          </div>
          <div
            id="timelineContainer"
            class="timeline-container relative overflow-x-hidden"
          >
            <div
              class="timeline-line absolute left-4 top-0 bottom-0 w-1 bg-gray-300"
            ></div>
            <!-- 時間軸項目將由 JavaScript 動態填充 -->
          </div>
          <!-- 新增時間軸項目按鈕 -->
          <div class="mt-4 flex justify-center">
            <button
              class="add-button flex items-center justify-center w-12 h-12 bg-blue-500 hover:bg-blue-700 text-white rounded-full"
              onclick="addTimelineItem()"
              title="新增時間軸項目"
            >
              +
            </button>
          </div>
        </div>

        <!-- 相關資料 (替換原本的場地資訊) -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4">相關資料</h2>
          <div id="resourcesContainer" class="space-y-4">
            <!-- 資源內容將由 JavaScript 動態填充 -->
          </div>
          <!-- 新增相關資料按鈕 -->
          <div class="mt-4 flex justify-center">
            <button
              class="add-button flex items-center justify-center w-12 h-12 bg-blue-500 hover:bg-blue-700 text-white rounded-full"
              onclick="addResourceItem()"
              title="新增相關資料"
            >
              +
            </button>
          </div>
        </div>
      </div>

      <!-- 聯絡人資訊 -->
      <div class="bg-white rounded-lg shadow mt-6 p-6">
        <h2 class="text-xl font-semibold mb-4">聯絡窗口</h2>
        <div
          id="contactsContainer"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        >
          <!-- 聯絡人資訊將由 JavaScript 動態填充 -->
        </div>
        <!-- 新增聯絡人按鈕 -->
        <div class="mt-4 flex justify-center">
          <button
            class="add-button flex items-center justify-center w-12 h-12 bg-blue-500 hover:bg-blue-700 text-white rounded-full"
            onclick="addContactItem()"
            title="新增聯絡窗口"
          >
            +
          </button>
        </div>
      </div>
    </div>

    <!-- 模態框區域 -->
    <div id="modals">
      <!-- 時間軸編輯模態框 -->
      <div
        id="editModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50"
      >
        <div
          class="relative top-10 mx-auto p-5 border w-full sm:w-96 shadow-lg rounded-md bg-white"
        >
          <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">
              編輯時間軸事件
            </h3>
            <form id="editTimelineForm">
              <input type="hidden" id="eventId" />
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="phase"
                  >執行階段</label
                >
                <select
                  id="phase"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  required
                >
                  <option value="初步接觸">初步接觸</option>
                  <option value="確認合作項目">確認合作項目</option>
                  <option value="場地勘查">場地勘查</option>
                  <option value="設備部署">設備部署</option>
                  <option value="數據收集">數據收集</option>
                  <option value="分析與優化">分析與優化</option>
                  <option value="完成階段">完成階段</option>
                </select>
              </div>
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="date"
                  >日期時間</label
                >
                <input
                  type="datetime-local"
                  id="date"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  required
                />
              </div>
              <div class="mb-6">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="description"
                  >描述</label
                >
                <textarea
                  id="description"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div class="flex items-center justify-between">
                <button
                  type="submit"
                  class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                  儲存
                </button>
                <button
                  type="button"
                  onclick="closeEditModal()"
                  class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                  取消
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- 基本資訊編輯模態框（更新後） -->
      <div
        id="basicInfoModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50"
      >
        <div
          class="relative top-10 mx-auto p-5 border w-full sm:w-96 shadow-lg rounded-md bg-white"
        >
          <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">
              編輯基本資訊
            </h3>
            <form id="editBasicInfoForm">
              <input type="hidden" id="basicInfoId" />
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="basicInstitution"
                  >機構名稱</label
                >
                <input
                  type="text"
                  id="basicInstitution"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  required
                />
              </div>
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="basicDepartment"
                  >部門名稱</label
                >
                <input
                  type="text"
                  id="basicDepartment"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                />
              </div>
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="basicProjectName"
                  >主責子計畫</label
                >
                <select
                  id="basicProjectName"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  required
                >
                  <option value="">請選擇子計畫</option>
                  <option value="子計畫三">子計畫三</option>
                  <option value="子計畫四">子計畫四</option>
                  <option value="子計畫五">子計畫五</option>
                  <option value="子計畫六">子計畫六</option>
                  <option value="子計畫七">子計畫七</option>
                  <option value="子計畫八">子計畫八</option>
                  <option value="子計畫九">子計畫九</option>
                </select>
              </div>
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="basicProjectCustomName"
                  >合作項目</label
                >
                <input
                  type="text"
                  id="basicProjectCustomName"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  required
                />
              </div>
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="basicProjectContent"
                  >合作項目內容</label
                >
                <textarea
                  id="basicProjectContent"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div class="flex items-center justify-between">
                <button
                  type="submit"
                  class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                  儲存
                </button>
                <button
                  type="button"
                  onclick="closeBasicInfoModal()"
                  class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                  取消
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- 資源編輯模態框 -->
      <div
        id="resourceModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50"
      >
        <div
          class="relative top-10 mx-auto p-5 border w-full sm:w-96 shadow-lg rounded-md bg-white"
        >
          <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">
              編輯資源
            </h3>
            <form id="editResourceForm">
              <input type="hidden" id="resourceId" />
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="resourceTitle"
                  >標題</label
                >
                <input
                  type="text"
                  id="resourceTitle"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  required
                />
              </div>
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="resourceType"
                  >類型</label
                >
                <select
                  id="resourceType"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  required
                >
                  <option value="text">文字</option>
                  <option value="link">連結</option>
                </select>
              </div>
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="resourceContent"
                  >內容</label
                >
                <textarea
                  id="resourceContent"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div class="mb-6">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="resourceUrl"
                  >相關連結（選填）</label
                >
                <input
                  type="url"
                  id="resourceUrl"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                />
              </div>
              <div class="flex items-center justify-between">
                <button
                  type="submit"
                  class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                  儲存
                </button>
                <button
                  type="button"
                  onclick="closeResourceModal()"
                  class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                  取消
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- 聯絡窗口編輯模態框 -->
      <div
        id="contactModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50"
      >
        <div
          class="relative top-10 mx-auto p-5 border w-full sm:w-96 shadow-lg rounded-md bg-white"
        >
          <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">
              編輯聯絡窗口
            </h3>
            <form id="editContactForm">
              <input type="hidden" id="contactId" />
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="contactName"
                  >姓名</label
                >
                <input
                  type="text"
                  id="contactName"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  required
                />
              </div>
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="contactTitle"
                  >職稱</label
                >
                <input
                  type="text"
                  id="contactTitle"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  required
                />
              </div>
              <div class="mb-4">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="contactEmail"
                  >Email</label
                >
                <input
                  type="email"
                  id="contactEmail"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                  required
                />
              </div>
              <div class="mb-6">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="contactPhone"
                  >電話（選填）</label
                >
                <input
                  type="tel"
                  id="contactPhone"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                />
              </div>
              <div class="flex items-center justify-between">
                <button
                  type="submit"
                  class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                  儲存
                </button>
                <button
                  type="button"
                  onclick="closeContactModal()"
                  class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                  取消
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- 時間軸事件詳細資料模態框 -->
      <div
        id="detailModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50"
      >
        <div
          class="relative top-10 mx-auto p-5 border w-full sm:w-96 shadow-lg rounded-md bg-white"
        >
          <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">
              事件詳細資訊
            </h3>
            <div id="detailContent" class="space-y-2">
              <!-- 詳細資料將由 JavaScript 動態填充 -->
            </div>
            <div class="flex justify-end mt-4">
              <button
                type="button"
                onclick="closeDetailModal()"
                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
              >
                關閉
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 在頂部定義全域變數
      let isReverseOrder = true; // 預設為倒序排列

      // 設置時區常量
      const TIME_ZONE = "Asia/Taipei";

      // 格式化日期為指定時區的本地字符串
      function formatDateToLocaleString(date) {
        return new Intl.DateTimeFormat("zh-TW", {
          timeZone: TIME_ZONE,
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        }).format(date);
      }

      // 格式化日期為 datetime-local 所需的格式，指定時區
      function formatDateToInputValue(date) {
        const options = {
          timeZone: TIME_ZONE,
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        };
        const formatter = new Intl.DateTimeFormat("en-CA", options); // en-CA 格式為 YYYY-MM-DD
        const parts = formatter.formatToParts(date);
        const dateParts = {};
        parts.forEach(({ type, value }) => {
          dateParts[type] = value;
        });
        return `${dateParts.year}-${dateParts.month}-${dateParts.day}T${dateParts.hour}:${dateParts.minute}`;
      }

      // 獲取當前台灣時間
      function getCurrentTaiwanTime() {
        return new Date().toLocaleString("en-US", { timeZone: TIME_ZONE });
      }

      // 修改顯示日期的函數，使用台灣時間
      function formatDisplayDate(dateString) {
        const date = new Date(dateString);
        const options = {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        };
        return new Intl.DateTimeFormat("zh-TW", options).format(date);
      }

      // 檢查用戶權限
      function checkPermissions() {
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const navButtons = document.getElementById("navButtons");

        let navHTML = `
            <a href="/partners.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200">
              返回列表
            </a>
          `;

        const hasPermission = checkUserPermission();

        if (hasPermission && window.partnerData?._id) {
          navHTML += `
              <a href="/partner-management.html?id=${window.partnerData._id}"
                 class="ml-4 px-3 py-2 rounded-md text-sm font-medium text-white bg-blue-500 hover:bg-blue-700">
                編輯資料
              </a>
            `;
        }

        navButtons.innerHTML = navHTML;
      }

      // 統一的權限檢查函數
      function checkUserPermission() {
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const currentCountryCode = window.partnerData?.country?.code;

        if (user.role === "admin") {
          return true;
        }

        if (!Array.isArray(user.assignedCountries)) {
          return false;
        }

        return user.assignedCountries.includes(currentCountryCode);
      }

      // 載入合作夥伴資料
      async function loadPartnerData() {
        const urlParams = new URLSearchParams(window.location.search);
        const partnerId = urlParams.get("id");

        if (!partnerId) {
          window.location.href = "/partners.html";
          return;
        }

        try {
          const token = localStorage.getItem("token");
          const response = await fetch(`/api/partners/${partnerId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          window.partnerData = data;
          updateUI(data);
          checkPermissions();
        } catch (error) {
          console.error("Error loading partner data:", error);
          alert("載入合作夥伴資料時發生錯誤：" + error.message);
        }
      }

      // 更新 UI
      function updateUI(data) {
        // 從時間軸中獲取最新階段
        const latestPhase = getLatestPhase(data.timeline);

        // 更新 data.progress 物件
        data.progress = {
          ...data.progress,
          phase: latestPhase.phase,
          lastUpdate: latestPhase.date,
          details: latestPhase.description,
        };

        // 更新基本資訊
        document.getElementById("basicInfo").innerHTML = `
          <div class="relative bg-white rounded-lg p-6">
            <!-- 頂部資訊列 -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0 sm:space-x-6">
              <div class="flex items-center space-x-3">
                <span class="inline-block bg-blue-100 text-blue-800 px-4 py-1 rounded-full text-sm font-medium border border-blue-200">
                  ${data.project.subProject}
                </span>
                <div class="flex items-center">
                  <span class="${getPhaseColor(data.progress.phase)}">
                      ${data.progress.phase}
                  </span>
                </div>
              </div>
              <div class="flex items-center text-gray-500 text-sm">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                ${formatDisplayDate(data.updatedAt || data.createdAt)}
              </div>
            </div>
      
            <!-- 主要內容 -->
            <div class="space-y-6">
              <!-- 國家資訊 -->
              <div class="flex flex-col sm:flex-row items-center sm:items-start space-y-4 sm:space-y-0 sm:space-x-4">
                <span class="text-4xl">${data.country.flag}</span>
                <div>
                  <h1 class="text-2xl font-bold text-gray-900">${
                    data.country.name
                  }</h1>
                  <p class="text-gray-500 text-sm">${data.country.code}</p>
                </div>
              </div>
      
              <!-- 機構資訊 -->
              <div class="border-l-4 border-blue-500 pl-4">
                <h2 class="text-xl text-blue-600 font-semibold">
                  ${data.institution.name}
                </h2>
                ${
                  data.institution.department
                    ? `<p class="text-gray-600 mt-1">${data.institution.department}</p>`
                    : ""
                }
              </div>
      
              <!-- 合作項目資訊 -->
              <div class="space-y-6">
                <!-- 合作項目 -->
                <div class="bg-gray-50 rounded-lg p-4">
                  <h3 class="text-base font-medium text-gray-700 uppercase tracking-wider mb-2">合作項目</h3>
                  <p class="text-gray-600 text-base">${
                    data.project.name || "尚未設定"
                  }</p>
                </div>
                <!-- 合作項目內容 -->
                ${
                  data.project.content
                    ? `
                  <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-base font-medium text-gray-700 uppercase tracking-wider mb-2">合作項目內容</h3>
                    <div class="prose max-w-none">
                      <p class="text-gray-600 text-base leading-relaxed whitespace-pre-line">${data.project.content}</p>
                    </div>
                  </div>
                  `
                    : ""
                }
              </div>
            </div>
          </div>
        `;

        const hasPermission = checkUserPermission();

        // 更新編輯按鈕
        const basicInfoEditButton = document.getElementById(
          "basicInfoEditButton"
        );
        if (hasPermission) {
          basicInfoEditButton.innerHTML = `
            <button
              onclick="editBasicInfo()"
              class="px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-700 flex items-center"
              title="編輯基本資訊"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
              </svg>
              編輯
            </button>
          `;
        } else {
          basicInfoEditButton.innerHTML = "";
        }

        // 更新時間軸
        const sortedTimeline = (data.timeline || []).sort((a, b) => {
          return isReverseOrder
            ? new Date(b.date) - new Date(a.date) // 新到舊
            : new Date(a.date) - new Date(b.date); // 舊到新
        });

        const timelineHTML = sortedTimeline
          .map(
            (item) => `
                <div class="timeline-item ${
                  item.type || "update"
                } flex relative" onclick="showDetail('${item._id}')">
                  <div class="flex flex-col items-center">
                    <div class="timeline-dot ${item.type || "update"}"></div>
                  </div>
                  <div class="timeline-content ml-6 p-4 bg-gray-100 rounded-lg w-full">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                      <span class="font-medium">${item.phase}</span>
                      <div class="flex items-center space-x-2 mt-2 sm:mt-0">
                        <span class="timeline-badge badge-${
                          item.type || "update"
                        }">${getTimelineBadgeText(item.type)}</span>
                        ${
                          hasPermission
                            ? `
                              <button
                                onclick="editTimelineEvent(event, '${
                                  item._id
                                }', ${JSON.stringify(item).replace(
                                /"/g,
                                "&quot;"
                              )})"
                                class="text-blue-600 hover:text-blue-800 text-sm"
                                title="編輯"
                              >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                              </button>
                              <button
                                onclick="deleteTimelineEvent(event, '${
                                  item._id
                                }')"
                                class="text-red-600 hover:text-red-800 text-sm"
                                title="刪除"
                              >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                              </button>
                            `
                            : ""
                        }
                      </div>
                    </div>
                    <div class="text-gray-500 text-sm mt-1">
                      ${formatDisplayDate(item.date)}
                    </div>
                    <div class="mt-2 text-gray-700">
                      ${item.description}
                    </div>
                  </div>
                </div>
              `
          )
          .join("");

        const timelineContainer = document.getElementById("timelineContainer");
        timelineContainer.innerHTML = `
            ${timelineHTML}
          `;

        // 更新資源區塊
        const resourcesHTML = (data.resources || [])
          .sort((a, b) => a.order - b.order)
          .map(
            (resource) => `
                <div class="border rounded-lg p-4 space-y-2">
                  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <h3 class="font-medium text-lg">${resource.title}</h3>
                    <div class="flex items-center space-x-2">
                      <span class="text-sm text-gray-500">
                        ${formatDisplayDate(resource.createdAt)}
                      </span>
                      ${
                        hasPermission
                          ? `
                            <button
                              onclick="editResource(event, '${
                                resource._id
                              }', ${JSON.stringify(resource).replace(
                              /"/g,
                              "&quot;"
                            )})"
                              class="text-blue-600 hover:text-blue-800 text-sm"
                              title="編輯"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                              </svg>
                            </button>
                            <button
                              onclick="deleteResource(event, '${resource._id}')"
                              class="text-red-600 hover:text-red-800 text-sm"
                              title="刪除"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                            </button>
                          `
                          : ""
                      }
                    </div>
                  </div>
                  <div class="prose max-w-none">
                    ${
                      resource.type === "link"
                        ? `<a href="${resource.url}" target="_blank" class="text-blue-600 hover:underline">${resource.content}</a>`
                        : `<p class="whitespace-pre-wrap">${resource.content}</p>`
                    }
                  </div>
                  ${
                    resource.url && resource.type !== "link"
                      ? `<div class="mt-2">
                          <a href="${resource.url}" target="_blank" class="text-sm text-blue-600 hover:underline">相關連結</a>
                        </div>`
                      : ""
                  }
                </div>
              `
          )
          .join("");

        const resourcesContainer =
          document.getElementById("resourcesContainer");
        resourcesContainer.innerHTML =
          resourcesHTML ||
          '<p class="text-gray-500 text-center">尚無相關資料</p>';

        // 更新聯絡人資訊
        const contactsHTML = (data.contacts || [])
          .map(
            (contact) => `
                <div class="border rounded-lg p-4 space-y-2">
                  <h3 class="font-medium">${contact.name}</h3>
                  <p class="text-gray-600 text-sm mt-1">${contact.title}</p>
                  <div class="mt-2 space-y-1">
                    <p class="text-sm">
                      <span class="text-gray-500">Email:</span>
                      <a href="mailto:${contact.email}" class="text-blue-600">${
              contact.email
            }</a>
                    </p>
                    ${
                      contact.phone
                        ? `<p class="text-sm">
                            <span class="text-gray-500">電話:</span>
                            <a href="tel:${contact.phone}" class="text-blue-600">${contact.phone}</a>
                          </p>`
                        : ""
                    }
                  </div>
                  ${
                    hasPermission
                      ? `
                        <div class="flex justify-end mt-4 space-x-2">
                          <button
                            onclick="editContact(event, '${
                              contact._id
                            }', ${JSON.stringify(contact).replace(
                          /"/g,
                          "&quot;"
                        )})"
                            class="text-blue-600 hover:text-blue-800 text-sm"
                            title="編輯"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                          </button>
                          <button
                            onclick="deleteContact(event, '${contact._id}')"
                            class="text-red-600 hover:text-red-800 text-sm"
                            title="刪除"
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                          </button>
                        </div>
                      `
                      : ""
                  }
                </div>
              `
          )
          .join("");

        const contactsContainer = document.getElementById("contactsContainer");
        contactsContainer.innerHTML =
          contactsHTML ||
          '<p class="text-gray-500 text-center">尚無聯絡窗口資訊</p>';
      }

      // 輔助函數：獲取時間軸徽章文字
      function getTimelineBadgeText(type) {
        const badgeTexts = {
          create: "新增",
          update: "更新",
          delete: "刪除",
          contact: "聯絡",
          phase: "階段",
        };
        return badgeTexts[type] || "更新";
      }

      // 輔助函數：獲取徽章顏色
      function getBadgeColor(type) {
        const badgeColors = {
          create: "green-500",
          update: "blue-500",
          delete: "red-500",
          contact: "purple-500",
          phase: "orange-500",
        };
        return badgeColors[type] || "blue-500";
      }

      // 輔助函數：獲取最新的時間軸階段
      function getLatestPhase(timeline) {
        if (!timeline || timeline.length === 0) {
          return {
            phase: "初步接觸",
            date: new Date().toISOString(),
            description: "",
          };
        }

        // 根據日期排序時間軸，最新的在前
        const sortedTimeline = [...timeline].sort((a, b) => {
          return new Date(b.date) - new Date(a.date);
        });

        // 返回最新的事件階段和描述
        return {
          phase: sortedTimeline[0].phase,
          date: sortedTimeline[0].date,
          description: sortedTimeline[0].description,
        };
      }

      // 時間軸操作函數
      async function addTimelineItem() {
        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        // 獲取當前台灣時間
        const currentTaiwanTime = new Date(getCurrentTaiwanTime());

        editTimelineEvent(null, null, {
          event: "階段更新", // 預設事件名稱
          phase: "初步接觸",
          description: "",
          date: currentTaiwanTime.toISOString(),
          type: "create", // 確保 type 為 'create' 新增事件
          isMain: false, // 預設非主責項目
        });
      }

      function editTimelineEvent(event, eventId, eventData) {
        // 如果 event 存在，阻止事件冒泡
        if (event && event.stopPropagation) {
          event.stopPropagation();
        }

        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        const modal = document.getElementById("editModal");
        const form = document.getElementById("editTimelineForm");

        if (eventId) {
          // 編輯現有事件
          document.getElementById("eventId").value = eventId;
          document.getElementById("phase").value =
            eventData.phase || "初步接觸";
          document.getElementById("description").value =
            eventData.description || "";
          const date = new Date(eventData.date);
          if (isNaN(date.getTime())) {
            alert("事件日期無效。");
            return;
          }
          const formattedDate = formatDateToInputValue(date);
          document.getElementById("date").value = formattedDate;
        } else {
          // 新增新事件
          document.getElementById("eventId").value = "";
          document.getElementById("phase").value =
            eventData.phase || "初步接觸";
          document.getElementById("description").value =
            eventData.description || "";
          const date = new Date(eventData.date);
          if (isNaN(date.getTime())) {
            alert("事件日期無效。");
            return;
          }
          const formattedDate = formatDateToInputValue(date);
          document.getElementById("date").value = formattedDate;
        }

        modal.classList.remove("hidden");

        form.onsubmit = async (e) => {
          e.preventDefault();
          await updateTimelineEvent();
        };
      }

      function closeEditModal() {
        const modal = document.getElementById("editModal");
        modal.classList.add("hidden");
      }

      async function updateTimelineEvent() {
        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        const eventId = document.getElementById("eventId").value;
        const partnerId = window.partnerData._id;
        const token = localStorage.getItem("token");

        const phase = document.getElementById("phase").value;
        const description = document.getElementById("description").value.trim();
        const dateValue = document.getElementById("date").value;

        if (!dateValue) {
          alert("請輸入有效的日期時間。");
          return;
        }

        // 將使用者輸入的日期時間（假設為台北時間）轉換為 UTC ISO 字符串
        const date = new Date(`${dateValue}:00+08:00`);
        const utcDate = date.toISOString();

        if (isNaN(date.getTime())) {
          alert("請輸入有效的日期時間。");
          return;
        }

        // 檢查該階段是否已經存在於 timeline 中
        let type = "create";
        const existingEvents = window.partnerData.timeline || [];
        const phaseExists = existingEvents.some(
          (event) =>
            event.phase === phase && (!eventId || event._id !== eventId) // 排除正在編輯的事件
        );

        if (phaseExists) {
          type = "update";
        }

        // 準備資料
        const updatedData = {
          event: `階段更新：${phase}`,
          description: description,
          phase: phase,
          date: utcDate, // 使用 UTC ISO 字符串
          type: type, // 明確設置 type
        };

        console.log("Sending data with type:", type); // 添加日誌以確認 type 值

        try {
          const response = await fetch(
            eventId
              ? `/api/partners/${partnerId}/timeline/${eventId}`
              : `/api/partners/${partnerId}/timeline`,
            {
              method: eventId ? "PUT" : "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(updatedData),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.message || `HTTP error! status: ${response.status}`
            );
          }

          closeEditModal();
          await loadPartnerData();
        } catch (error) {
          console.error("Error updating timeline event:", error);
          alert("更新事件時發生錯誤：" + error.message);
        }
      }

      async function deleteTimelineEvent(event, eventId) {
        // 阻止事件冒泡
        if (event && event.stopPropagation) {
          event.stopPropagation();
        }

        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        if (!confirm("確定要刪除此事件嗎？")) {
          return;
        }

        const token = localStorage.getItem("token");
        const partnerId = window.partnerData._id;

        try {
          const response = await fetch(
            `/api/partners/${partnerId}/timeline/${eventId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.message || `HTTP error! status: ${response.status}`
            );
          }

          await loadPartnerData();
        } catch (error) {
          console.error("Error deleting timeline event:", error);
          alert("刪除事件時發生錯誤：" + error.message);
        }
      }

      // 資源相關函數
      async function addResourceItem() {
        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        editResource(null, null, {
          title: "",
          type: "text",
          content: "",
          url: "",
        });
      }

      function editResource(event, resourceId, resourceData) {
        // 如果 event 存在，阻止事件冒泡
        if (event && event.stopPropagation) {
          event.stopPropagation();
        }

        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        const modal = document.getElementById("resourceModal");
        const form = document.getElementById("editResourceForm");

        if (resourceId) {
          // 編輯現有資源
          document.getElementById("resourceId").value = resourceId;
          document.getElementById("resourceTitle").value =
            resourceData.title || "";
          document.getElementById("resourceType").value =
            resourceData.type || "text";
          document.getElementById("resourceContent").value =
            resourceData.content || "";
          document.getElementById("resourceUrl").value = resourceData.url || "";
        } else {
          // 新增新資源
          document.getElementById("resourceId").value = "";
          document.getElementById("resourceTitle").value = "";
          document.getElementById("resourceType").value = "text";
          document.getElementById("resourceContent").value = "";
          document.getElementById("resourceUrl").value = "";
        }

        modal.classList.remove("hidden");

        form.onsubmit = async (e) => {
          e.preventDefault();
          await updateResource();
        };
      }

      function closeResourceModal() {
        const modal = document.getElementById("resourceModal");
        modal.classList.add("hidden");
      }

      async function updateResource() {
        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        const resourceId = document.getElementById("resourceId").value;
        const partnerId = window.partnerData._id;
        const token = localStorage.getItem("token");

        const updatedResource = {
          title: document.getElementById("resourceTitle").value.trim(),
          type: document.getElementById("resourceType").value,
          content: document.getElementById("resourceContent").value.trim(),
          url: document.getElementById("resourceUrl").value.trim(),
          order:
            window.partnerData.resources.find((r) => r._id === resourceId)
              ?.order || 0,
        };

        try {
          const response = await fetch(
            resourceId
              ? `/api/partners/${partnerId}/resources/${resourceId}`
              : `/api/partners/${partnerId}/resources`,
            {
              method: resourceId ? "PUT" : "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(updatedResource),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.message || `HTTP error! status: ${response.status}`
            );
          }

          closeResourceModal();
          await loadPartnerData();
        } catch (error) {
          console.error("Error updating resource:", error);
          alert("更新資源時發生錯誤：" + error.message);
        }
      }

      async function deleteResource(event, resourceId) {
        // 阻止事件冒泡
        if (event && event.stopPropagation) {
          event.stopPropagation();
        }

        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        if (!confirm("確定要刪除此資源嗎？")) {
          return;
        }

        const token = localStorage.getItem("token");
        const partnerId = window.partnerData._id;

        try {
          const response = await fetch(
            `/api/partners/${partnerId}/resources/${resourceId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.message || `HTTP error! status: ${response.status}`
            );
          }

          await loadPartnerData();
        } catch (error) {
          console.error("Error deleting resource:", error);
          alert("刪除資源時發生錯誤：" + error.message);
        }
      }

      // 聯絡窗口相關函數
      async function addContactItem() {
        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        editContact(null, null, {
          name: "",
          title: "",
          email: "",
          phone: "",
        });
      }

      function editContact(event, contactId, contactData) {
        // 如果 event 存在，阻止事件冒泡
        if (event && event.stopPropagation) {
          event.stopPropagation();
        }

        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        const modal = document.getElementById("contactModal");
        const form = document.getElementById("editContactForm");

        if (contactId) {
          // 編輯現有聯絡人
          document.getElementById("contactId").value = contactId;
          document.getElementById("contactName").value = contactData.name || "";
          document.getElementById("contactTitle").value =
            contactData.title || "";
          document.getElementById("contactEmail").value =
            contactData.email || "";
          document.getElementById("contactPhone").value =
            contactData.phone || "";
        } else {
          // 新增新聯絡人
          document.getElementById("contactId").value = "";
          document.getElementById("contactName").value = "";
          document.getElementById("contactTitle").value = "";
          document.getElementById("contactEmail").value = "";
          document.getElementById("contactPhone").value = "";
        }

        modal.classList.remove("hidden");

        form.onsubmit = async (e) => {
          e.preventDefault();
          await updateContact();
        };
      }

      function closeContactModal() {
        const modal = document.getElementById("contactModal");
        modal.classList.add("hidden");
      }

      async function updateContact() {
        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        const contactId = document.getElementById("contactId").value;
        const partnerId = window.partnerData._id;
        const token = localStorage.getItem("token");

        const updatedContact = {
          name: document.getElementById("contactName").value.trim(),
          title: document.getElementById("contactTitle").value.trim(),
          email: document.getElementById("contactEmail").value.trim(),
          phone: document.getElementById("contactPhone").value.trim(),
        };

        try {
          const response = await fetch(
            contactId
              ? `/api/partners/${partnerId}/contacts/${contactId}`
              : `/api/partners/${partnerId}/contacts`,
            {
              method: contactId ? "PUT" : "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(updatedContact),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.message || `HTTP error! status: ${response.status}`
            );
          }

          closeContactModal();
          await loadPartnerData();
        } catch (error) {
          console.error("Error updating contact:", error);
          alert("更新聯絡人時發生錯誤：" + error.message);
        }
      }

      async function deleteContact(event, contactId) {
        // 阻止事件冒泡
        if (event && event.stopPropagation) {
          event.stopPropagation();
        }

        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        if (!confirm("確定要刪除此聯絡人嗎？")) {
          return;
        }

        const token = localStorage.getItem("token");
        const partnerId = window.partnerData._id;

        try {
          const response = await fetch(
            `/api/partners/${partnerId}/contacts/${contactId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.message || `HTTP error! status: ${response.status}`
            );
          }

          await loadPartnerData();
        } catch (error) {
          console.error("Error deleting contact:", error);
          alert("刪除聯絡人時發生錯誤：" + error.message);
        }
      }

      // 新增函數：顯示事件詳細資料
      function showDetail(eventId) {
        const timeline = window.partnerData.timeline || [];
        const eventData = timeline.find((item) => item._id === eventId);

        if (!eventData) {
          alert("找不到該事件的詳細資料。");
          return;
        }

        const detailContent = document.getElementById("detailContent");
        const formattedDate = formatDisplayDate(eventData.date);

        detailContent.innerHTML = `
            <p><strong>執行階段：</strong> ${eventData.phase}</p>
            <p><strong>事件名稱：</strong> ${eventData.event}</p>
            <p><strong>日期時間：</strong> ${formattedDate}</p>
            <p><strong>描述：</strong> ${eventData.description}</p>
            ${
              eventData.type
                ? `<p><strong>類型：</strong> ${getTimelineBadgeText(
                    eventData.type
                  )}</p>`
                : ""
            }
          `;

        const detailModal = document.getElementById("detailModal");
        detailModal.classList.remove("hidden");
      }

      function closeDetailModal() {
        const detailModal = document.getElementById("detailModal");
        detailModal.classList.add("hidden");
      }

      // 基本資訊編輯相關函數（更新後）
      function editBasicInfo() {
        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        const modal = document.getElementById("basicInfoModal");
        const form = document.getElementById("editBasicInfoForm");

        // 填充現有資料
        document.getElementById("basicInstitution").value =
          window.partnerData.institution.name || "";
        document.getElementById("basicDepartment").value =
          window.partnerData.institution.department || "";
        document.getElementById("basicProjectName").value =
          window.partnerData.project.subProject || "";
        document.getElementById("basicProjectCustomName").value =
          window.partnerData.project.name || "";
        document.getElementById("basicProjectContent").value =
          window.partnerData.project.content || "";

        modal.classList.remove("hidden");

        form.onsubmit = async (e) => {
          e.preventDefault();
          await updateBasicInfo();
        };
      }

      function closeBasicInfoModal() {
        const modal = document.getElementById("basicInfoModal");
        modal.classList.add("hidden");
      }

      async function updateBasicInfo() {
        if (!checkUserPermission()) {
          alert("您沒有權限執行此操作");
          return;
        }

        const partnerId = window.partnerData._id;
        const token = localStorage.getItem("token");

        const updatedBasicInfo = {
          // 保留原有的國家資訊
          country: window.partnerData.country,
          institution: {
            name: document.getElementById("basicInstitution").value.trim(),
            department: document.getElementById("basicDepartment").value.trim(),
          },
          project: {
            subProject: document.getElementById("basicProjectName").value,
            name: document
              .getElementById("basicProjectCustomName")
              .value.trim(),
            content: document
              .getElementById("basicProjectContent")
              .value.trim(),
          },
          // 加入 progress 資訊
          progress: window.partnerData.progress, // 保留原有的進度資訊
        };

        try {
          const response = await fetch(`/api/partners/${partnerId}`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updatedBasicInfo),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.message || `HTTP error! status: ${response.status}`
            );
          }

          closeBasicInfoModal();
          await loadPartnerData();
          alert("基本資訊已成功更新！");
        } catch (error) {
          console.error("Error updating basic info:", error);
          alert("更新基本資訊時發生錯誤：" + error.message);
        }
      }

      // 漢堡選單功能
      function setupHamburgerMenu() {
        const hamburger = document.getElementById("hamburger");
        const navLinks = document.getElementById("navLinks");

        if (hamburger && navLinks) {
          hamburger.addEventListener("click", () => {
            const isExpanded = navLinks.classList.toggle("show");
            hamburger.classList.toggle("active");
            hamburger.setAttribute("aria-expanded", isExpanded);
          });

          // 當使用者點擊選單中的連結時，關閉選單
          navLinks.addEventListener("click", (e) => {
            if (e.target.classList.contains("nav-item")) {
              navLinks.classList.remove("show");
              hamburger.classList.remove("active");
              hamburger.setAttribute("aria-expanded", "false");
            }
          });
        }
      }

      // 關閉漢堡選單
      function closeHamburgerMenu() {
        const hamburger = document.getElementById("hamburger");
        const navLinks = document.getElementById("navLinks");

        if (hamburger && navLinks && navLinks.classList.contains("show")) {
          navLinks.classList.remove("show");
          hamburger.classList.remove("active");
          hamburger.setAttribute("aria-expanded", "false");
        }
      }

      // 在 DOMContentLoaded 時添加模態框和初始化
      document.addEventListener("DOMContentLoaded", () => {
        // 初始化頁面數據
        loadPartnerData();

        // 添加切換倒序排列的事件監聽
        const reverseOrderToggle =
          document.getElementById("reverseOrderToggle");
        reverseOrderToggle.addEventListener("change", () => {
          isReverseOrder = reverseOrderToggle.checked;
          updateUI(window.partnerData); // 重新更新 UI 以反映排列順序
        });

        // 初始化漢堡選單
        setupHamburgerMenu();
      });

      // 新增這個輔助函數到 script 中
      function getPhaseColor(phase) {
        const phaseClasses = {
          初步接觸: "phase-badge phase-initial",
          確認合作項目: "phase-badge phase-confirm",
          場地勘查: "phase-badge phase-survey",
          設備部署: "phase-badge phase-deploy",
          數據收集: "phase-badge phase-collect",
          分析與優化: "phase-badge phase-analyze",
          完成階段: "phase-badge phase-complete",
        };

        return phaseClasses[phase] || "phase-badge phase-complete";
      }
    </script>
  </body>
</html>
