<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>合作夥伴管理</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background-color: #f5f5f5;
        padding: 0;
      }

      .nav-container {
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        margin-bottom: 20px;
      }

      .nav-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-logo {
        font-size: 1.25rem;
        font-weight: bold;
        color: #2563eb;
        text-decoration: none;
      }

      .nav-links {
        display: flex;
        gap: 1rem;
      }

      .nav-item {
        color: #4b5563;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
        cursor: pointer;
      }

      .nav-item:hover {
        background-color: #f3f4f6;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- 導覽列 -->
    <nav class="nav-container">
      <div class="nav-content">
        <a href="/" class="nav-logo">國際合作夥伴</a>
        <div class="nav-links" id="navLinks">
          <a href="/dashboard.html" class="nav-item">返回管理頁面</a>
        </div>
      </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 px-4">
      <form id="partnerForm" class="space-y-6">
        <!-- 基本資訊 -->
        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-4">基本資訊</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >國家</label
              >
              <select
                name="country"
                id="countrySelect"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              >
                <option value="">請選擇國家</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >機構名稱</label
              >
              <input
                type="text"
                name="institution"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >部門名稱</label
              >
              <input
                type="text"
                name="department"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >計畫名稱</label
              >
              <input
                type="text"
                name="projectName"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
          </div>
        </div>

        <!-- 進度資訊 -->
        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-4">進度資訊</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >當前階段</label
              >
              <select
                name="phase"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              >
                <option value="初步接觸">初步接觸</option>
                <option value="確認合作項目">確認合作項目</option>
                <option value="場地勘查">場地勘查</option>
                <option value="設備部署">設備部署</option>
                <option value="數據收集">數據收集</option>
                <option value="分析與優化">分析與優化</option>
                <option value="完成階段">完成階段</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >進度說明</label
              >
              <textarea
                name="progressDetails"
                rows="3"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- 場地資訊 -->
        <div class="bg-white shadow rounded-lg p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">場地資訊</h2>
            <button
              type="button"
              id="addSiteBtn"
              class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
            >
              新增場地
            </button>
          </div>
          <div id="sitesContainer" class="space-y-4">
            <!-- 場地表單會由 JavaScript 動態生成 -->
          </div>
        </div>

        <!-- 聯絡人資訊 -->
        <div class="bg-white shadow rounded-lg p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">聯絡窗口</h2>
            <button
              type="button"
              id="addContactBtn"
              class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
            >
              新增聯絡人
            </button>
          </div>
          <div id="contactsContainer" class="space-y-4">
            <!-- 聯絡人表單會由 JavaScript 動態生成 -->
          </div>
        </div>

        <!-- 儲存按鈕 -->
        <div class="flex justify-end">
          <button
            type="button"
            id="deleteBtn"
            style="display: none"
            class="mr-4 px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
          >
            刪除合作夥伴
          </button>
          <button
            type="button"
            onclick="history.back()"
            class="mr-4 px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50"
          >
            取消
          </button>
          <button
            type="submit"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            儲存
          </button>
        </div>
      </form>
    </div>

    <!-- 場地表單模板 -->
    <template id="siteTemplate">
      <div class="site-form border rounded-lg p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >場地名稱</label
            >
            <input
              type="text"
              name="sites[INDEX][name]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >場地類型</label
            >
            <input
              type="text"
              name="sites[INDEX][type]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">地址</label>
            <input
              type="text"
              name="sites[INDEX][location]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >使用狀態</label
            >
            <select
              name="sites[INDEX][status]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            >
              <option value="規劃中">規劃中</option>
              <option value="建置中">建置中</option>
              <option value="使用中">使用中</option>
              <option value="暫停使用">暫停使用</option>
            </select>
          </div>
        </div>
        <button
          type="button"
          class="remove-site mt-4 px-3 py-1 text-red-600 hover:text-red-800"
        >
          刪除場地
        </button>
      </div>
    </template>

    <!-- 聯絡人表單模板 -->
    <template id="contactTemplate">
      <div class="contact-form border rounded-lg p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">姓名</label>
            <input
              type="text"
              name="contacts[INDEX][name]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">職稱</label>
            <input
              type="text"
              name="contacts[INDEX][title]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input
              type="email"
              name="contacts[INDEX][email]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">電話</label>
            <input
              type="tel"
              name="contacts[INDEX][phone]"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
        </div>
        <button
          type="button"
          class="remove-contact mt-4 px-3 py-1 text-red-600 hover:text-red-800"
        >
          刪除聯絡人
        </button>
      </div>
    </template>

    <script>
      let siteCount = 0;
      let contactCount = 0;
      let countries = {}; // 新增全局變數存儲國家資料
      let isEditMode = false; // 新增編輯模式標記

      // 初始化國家選項
      async function initializeCountries() {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch("/api/partners/utils/countries", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("無法獲取國家列表");
          }

          countries = await response.json();
          const select = document.getElementById("countrySelect");

          // 清空現有選項，只保留預設選項
          select.innerHTML = '<option value="">請選擇國家</option>';

          Object.entries(countries).forEach(([code, data]) => {
            const option = document.createElement("option");
            option.value = code;
            option.textContent = `${data.flag} ${data.name}`;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("載入國家列表失敗:", error);
          alert("無法載入國家列表，請重新整理頁面或聯繫管理員");
        }
      }

      // 添加場地
      function addSite() {
        const template = document.getElementById("siteTemplate");
        const container = document.getElementById("sitesContainer");
        const clone = template.content.cloneNode(true);

        // 更新索引
        clone.querySelectorAll('[name*="INDEX"]').forEach((input) => {
          input.name = input.name.replace("INDEX", siteCount);
        });

        container.appendChild(clone);
        siteCount++;
      }

      // 添加聯絡人
      function addContact() {
        const template = document.getElementById("contactTemplate");
        const container = document.getElementById("contactsContainer");
        const clone = template.content.cloneNode(true);

        // 更新索引
        clone.querySelectorAll('[name*="INDEX"]').forEach((input) => {
          input.name = input.name.replace("INDEX", contactCount);
        });

        container.appendChild(clone);
        contactCount++;
      }

      // 表單提交處理
      async function handleSubmit(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const partnerId = new URLSearchParams(window.location.search).get("id");

        const data = {
          country: {
            code: formData.get("country"),
            name: countries[formData.get("country")]?.name,
            flag: countries[formData.get("country")]?.flag,
          },
          institution: {
            name: formData.get("institution"),
            department: formData.get("department"),
          },
          project: {
            name: formData.get("projectName"),
          },
          progress: {
            phase: formData.get("phase"),
            details: formData.get("progressDetails"),
            lastUpdate: new Date(),
          },
          sites: [],
          contacts: [],
        };

        // 基本資料驗證
        if (!data.country.code || !data.country.name || !data.country.flag) {
          alert("請選擇國家");
          return;
        }

        if (!data.institution.name) {
          alert("請輸入機構名稱");
          return;
        }

        if (!data.project.name) {
          alert("請輸入計畫名稱");
          return;
        }

        if (!data.progress.phase) {
          alert("請選擇執行階段");
          return;
        }

        // 收集場地資訊
        for (let i = 0; i < siteCount; i++) {
          const siteName = formData.get(`sites[${i}][name]`);
          if (siteName) {
            const site = {
              name: siteName,
              type: formData.get(`sites[${i}][type]`),
              location: formData.get(`sites[${i}][location]`),
              status: formData.get(`sites[${i}][status]`),
            };

            // 場地資料驗證
            if (!site.type || !site.location || !site.status) {
              alert(`請完整填寫場地 "${siteName}" 的所有必填資訊`);
              return;
            }

            data.sites.push(site);
          }
        }

        // 收集聯絡人資訊
        for (let i = 0; i < contactCount; i++) {
          const contactName = formData.get(`contacts[${i}][name]`);
          if (contactName) {
            const contact = {
              name: contactName,
              title: formData.get(`contacts[${i}][title]`),
              email: formData.get(`contacts[${i}][email]`),
              phone: formData.get(`contacts[${i}][phone]`),
            };

            // 聯絡人資料驗證
            if (!contact.title || !contact.email) {
              alert(`請完整填寫聯絡人 "${contactName}" 的所有必填資訊`);
              return;
            }

            // Email 格式驗證
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(contact.email)) {
              alert(`聯絡人 "${contactName}" 的 Email 格式不正確`);
              return;
            }

            data.contacts.push(contact);
          }
        }

        try {
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("未登入狀態");
          }

          const url = partnerId
            ? `/api/partners/${partnerId}`
            : "/api/partners";
          const method = partnerId ? "PUT" : "POST";

          const response = await fetch(url, {
            method: method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(data),
          });

          const responseData = await response.json();

          if (!response.ok) {
            throw new Error(responseData.message || "儲存失敗");
          }

          alert("儲存成功！");
          window.location.href = "/partners.html";
        } catch (error) {
          console.error("Error details:", error);
          alert(`儲存失敗: ${error.message}`);
        }
      }

      // 事件監聽器設置
      function setupEventListeners() {
        // 表單提交監聽
        const form = document.getElementById("partnerForm");
        if (form) {
          form.addEventListener("submit", handleSubmit);
        }

        // 新增與刪除按鈕監聽
        const addSiteBtn = document.getElementById("addSiteBtn");
        const addContactBtn = document.getElementById("addContactBtn");
        const deleteBtn = document.getElementById("deleteBtn");

        if (addSiteBtn) addSiteBtn.addEventListener("click", addSite);
        if (addContactBtn) addContactBtn.addEventListener("click", addContact);
        if (deleteBtn) deleteBtn.addEventListener("click", handleDelete);

        // 使用事件委派處理動態元素的刪除
        document.addEventListener("click", (event) => {
          if (event.target.classList.contains("remove-site")) {
            const siteForm = event.target.closest(".site-form");
            if (siteForm && confirm("確定要刪除此場地嗎？")) {
              siteForm.remove();
            }
          } else if (event.target.classList.contains("remove-contact")) {
            const contactForm = event.target.closest(".contact-form");
            if (contactForm && confirm("確定要刪除此聯絡人嗎？")) {
              contactForm.remove();
            }
          }
        });
      }

      // 初始化
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          await checkPermissions();
          await initializeCountries();
          setupEventListeners();
          await loadExistingData();
        } catch (error) {
          console.error("初始化失敗:", error);
          alert("頁面初始化失敗，請重新整理或聯繫管理員");
        }
      });

      // 載入現有資料（如果是編輯模式）

      async function loadExistingData() {
        const urlParams = new URLSearchParams(window.location.search);
        const partnerId = urlParams.get("id");

        if (partnerId) {
          document.getElementById("deleteBtn").style.display = "block";

          try {
            const token = localStorage.getItem("token");
            if (!token) {
              throw new Error("未登入狀態");
            }

            const response = await fetch(`/api/partners/${partnerId}`, {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            if (!response.ok) {
              throw new Error("無法載入資料");
            }

            const data = await response.json();
            if (!data) {
              throw new Error("資料格式錯誤");
            }

            populateForm(data);
          } catch (error) {
            console.error("載入資料失敗:", error);
            alert(`載入失敗: ${error.message}`);
          }
        }
      }

      // 添加刪除功能
      async function handleDelete() {
        const urlParams = new URLSearchParams(window.location.search);
        const partnerId = urlParams.get("id");

        if (!partnerId) return;

        // 確認提示
        if (!confirm("確定要刪除此合作夥伴嗎？此操作無法復原。")) {
          return;
        }

        try {
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("未登入狀態");
          }

          const response = await fetch(`/api/partners/${partnerId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.message || "刪除失敗");
          }

          alert("已成功刪除合作夥伴");
          window.location.href = "/partners.html";
        } catch (error) {
          console.error("Error details:", error);
          alert(`刪除失敗: ${error.message}`);
        }
      }

      // 在初始化時加入刪除按鈕的事件監聽
      document.addEventListener("DOMContentLoaded", () => {
        checkPermissions();
        initializeCountries();
        loadExistingData();

        // 事件監聽
        document
          .getElementById("addSiteBtn")
          .addEventListener("click", addSite);
        document
          .getElementById("addContactBtn")
          .addEventListener("click", addContact);
        document
          .getElementById("partnerForm")
          .addEventListener("submit", handleSubmit);
        document
          .getElementById("deleteBtn")
          .addEventListener("click", handleDelete);
      });

      // 填充表單資料
      function populateForm(data) {
        // 清空現有的場地和聯絡人容器
        document.getElementById("sitesContainer").innerHTML = "";
        document.getElementById("contactsContainer").innerHTML = "";

        // 重置計數器
        siteCount = 0;
        contactCount = 0;

        // 基本資訊
        document.querySelector('[name="country"]').value = data.country.code;
        document.querySelector('[name="institution"]').value =
          data.institution.name;
        document.querySelector('[name="department"]').value =
          data.institution.department || "";
        document.querySelector('[name="projectName"]').value =
          data.project.name;

        // 進度資訊
        document.querySelector('[name="phase"]').value = data.progress.phase;
        document.querySelector('[name="progressDetails"]').value =
          data.progress.details || "";

        // 場地資訊
        data.sites.forEach((site) => {
          addSite();
          const lastIndex = siteCount - 1;
          document.querySelector(`[name="sites[${lastIndex}][name]"]`).value =
            site.name;
          document.querySelector(`[name="sites[${lastIndex}][type]"]`).value =
            site.type;
          document.querySelector(
            `[name="sites[${lastIndex}][location]"]`
          ).value = site.location;
          document.querySelector(`[name="sites[${lastIndex}][status]"]`).value =
            site.status;
        });

        // 聯絡人資訊
        data.contacts.forEach((contact) => {
          addContact();
          const lastIndex = contactCount - 1;
          document.querySelector(
            `[name="contacts[${lastIndex}][name]"]`
          ).value = contact.name;
          document.querySelector(
            `[name="contacts[${lastIndex}][title]"]`
          ).value = contact.title;
          document.querySelector(
            `[name="contacts[${lastIndex}][email]"]`
          ).value = contact.email;
          document.querySelector(
            `[name="contacts[${lastIndex}][phone]"]`
          ).value = contact.phone || "";
        });
      }

      // 權限檢查
      // 修改後的權限檢查函數
      function checkPermissions() {
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const urlParams = new URLSearchParams(window.location.search);
        const partnerId = urlParams.get("id");

        // 如果沒有用戶資訊，導向登入頁面
        if (!user || !user.role) {
          window.location.href = "/login.html";
          return;
        }

        // 如果是管理員，直接允許訪問
        if (user.role === "admin") {
          return;
        }

        // 對一般用戶，檢查是否有該國家的權限
        fetch(`/api/partners/${partnerId}`, {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        })
          .then((response) => response.json())
          .then((partner) => {
            const hasCountryPermission = (
              user.assignedCountries || []
            ).includes(partner.country.code);
            if (!hasCountryPermission) {
              window.location.href = "/partners.html";
            }
          })
          .catch((error) => {
            console.error("權限檢查失敗:", error);
            window.location.href = "/partners.html";
          });
      }

      // 初始化
      document.addEventListener("DOMContentLoaded", () => {
        checkPermissions();
        initializeCountries();
        loadExistingData();

        // 事件監聽
        document
          .getElementById("addSiteBtn")
          .addEventListener("click", addSite);
        document
          .getElementById("addContactBtn")
          .addEventListener("click", addContact);
        document
          .getElementById("partnerForm")
          .addEventListener("submit", handleSubmit);
      });
    </script>
  </body>
</html>
