<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>合作夥伴管理</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background-color: #f5f5f5;
        padding: 0;
      }

      .nav-container {
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        margin-bottom: 20px;
      }

      .nav-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-logo {
        font-size: 1.25rem;
        font-weight: bold;
        color: #2563eb;
        text-decoration: none;
      }

      .nav-links {
        display: flex;
        gap: 1rem;
      }

      .nav-item {
        color: #4b5563;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
        cursor: pointer;
      }

      .nav-item:hover {
        background-color: #f3f4f6;
      }

      /* 新增和修改的 CSS 部分 */

      /* 統一所有 select 元素的高度和行高 */
      select {
        height: 2.5rem; /* 設置固定高度 */
        line-height: 2.5rem; /* 與高度一致 */
        padding-left: 0.5rem; /* 增加左側內邊距以防止內容過於靠近邊緣 */
        padding-right: 0.5rem; /* 增加右側內邊距 */
        appearance: none; /* 移除預設的外觀，方便自定義 */
        background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><polygon points="5,7 10,12 15,7" fill="%234b5563"/></svg>');
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1rem;
      }

      /* 調整 option 元素的對齊（部分瀏覽器可能不完全支持） */
      option {
        display: flex;
        align-items: center;
        height: 2.5rem; /* 與 select 高度一致 */
        padding: 0 0.5rem;
        font-size: 1rem;
      }

      /* 確保選項內的旗幟和文字垂直居中 */
      .option-content {
        display: flex;
        align-items: center;
      }

      /* 旗幟的樣式調整 */
      .option-content .flag {
        margin-right: 0.5rem;
        display: inline-block;
        font-size: 1rem; /* 調整旗幟大小以匹配文字 */
        line-height: 1;
      }

      /* 自定義選擇器的下拉箭頭 */
      select::-ms-expand {
        display: none; /* IE10+ */
      }

      /* 美化 select 元素的下拉箭頭（其他瀏覽器） */
      .select-wrapper {
        position: relative;
      }

      .select-wrapper::after {
        content: "";
        position: absolute;
        top: 50%;
        right: 1rem;
        width: 0;
        height: 0;
        pointer-events: none;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid #4b5563;
        transform: translateY(-50%);
      }

      /* 調整其他表單元素的樣式以保持一致性 */
      input[type="text"],
      input[type="email"],
      input[type="tel"],
      textarea {
        height: 2.5rem; /* 與 select 高度一致 */
        line-height: 2.5rem;
      }

      textarea {
        height: auto; /* 讓 textarea 根據內容自動調整高度 */
        min-height: 3rem;
      }

      button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- 導覽列 -->
    <nav class="nav-container">
      <div class="nav-content">
        <a href="/" class="nav-logo">國際合作夥伴</a>
        <div class="nav-links" id="navLinks">
          <a href="/partners.html" class="nav-item">返回列表</a>
        </div>
      </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 px-4">
      <form id="partnerForm" class="space-y-6">
        <!-- 基本資訊 -->
        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-4">基本資訊</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >國家</label
              >
              <select
                name="country"
                id="countrySelect"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              >
                <option value="">請選擇國家</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >機構名稱</label
              >
              <input
                type="text"
                name="institution"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >部門名稱</label
              >
              <input
                type="text"
                name="department"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >主責子計畫</label
              >
              <select
                name="projectName"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              >
                <option value="">請選擇子計畫</option>
                <option value="子計畫三">子計畫三</option>
                <option value="子計畫四">子計畫四</option>
                <option value="子計畫五">子計畫五</option>
                <option value="子計畫六">子計畫六</option>
                <option value="子計畫七">子計畫七</option>
                <option value="子計畫八">子計畫八</option>
                <option value="子計畫九">子計畫九</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700"
                >合作項目</label
              >
              <input
                type="text"
                name="project.name"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                placeholder="請輸入合作項目名稱"
              />
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700"
                >合作項目內容</label
              >
              <textarea
                name="project.content"
                id="projectContent"
                rows="4"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                placeholder="請輸入合作項目內容描述"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- 進度資訊 -->
        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-4">進度資訊</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >當前階段</label
              >
              <select
                name="phase"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              >
                <option value="初步接觸">初步接觸</option>
                <option value="確認合作項目">確認合作項目</option>
                <option value="場地勘查">場地勘查</option>
                <option value="設備部署">設備部署</option>
                <option value="數據收集">數據收集</option>
                <option value="分析與優化">分析與優化</option>
                <option value="完成階段">完成階段</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >進度說明</label
              >
              <textarea
                name="progressDetails"
                rows="3"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- 相關資料 -->
        <div class="bg-white shadow rounded-lg p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">相關資料</h2>
            <button
              type="button"
              id="addResourceBtn"
              class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
            >
              新增資料區塊
            </button>
          </div>
          <div id="resourcesContainer" class="space-y-4">
            <!-- 資源區塊將由 JavaScript 動態生成 -->
          </div>
        </div>

        <!-- 聯絡人資訊 -->
        <div class="bg-white shadow rounded-lg p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">聯絡窗口</h2>
            <button
              type="button"
              id="addContactBtn"
              class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
            >
              新增聯絡人
            </button>
          </div>
          <div id="contactsContainer" class="space-y-4">
            <!-- 聯絡人表單會由 JavaScript 動態生成 -->
          </div>
        </div>

        <!-- 儲存按鈕 -->
        <div class="flex justify-end">
          <button
            type="button"
            id="deleteBtn"
            style="display: none"
            class="mr-4 px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
          >
            刪除合作夥伴
          </button>
          <button
            type="button"
            onclick="history.back()"
            class="mr-4 px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50"
          >
            取消
          </button>
          <button
            type="submit"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            儲存
          </button>
        </div>
      </form>
    </div>

    <!-- 資源區塊模板 -->
    <template id="resourceTemplate">
      <div class="resource-form border rounded-lg p-4">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">標題</label>
            <input
              type="text"
              name="resources[INDEX][title]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >內容類型</label
            >
            <select
              name="resources[INDEX][type]"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              onchange="handleTypeChange(this)"
            >
              <option value="text">文字</option>
              <option value="link">連結</option>
              <option value="note">備註</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">內容</label>
            <textarea
              name="resources[INDEX][content]"
              rows="3"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            ></textarea>
          </div>
          <div class="url-field">
            <label class="block text-sm font-medium text-gray-700"
              >相關連結</label
            >
            <input
              type="url"
              name="resources[INDEX][url]"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              placeholder="https://"
            />
          </div>
        </div>
        <button
          type="button"
          class="remove-resource mt-4 px-3 py-1 text-red-600 hover:text-red-800"
        >
          刪除區塊
        </button>
      </div>
    </template>

    <!-- 聯絡人表單模板 -->
    <template id="contactTemplate">
      <div class="contact-form border rounded-lg p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">姓名</label>
            <input
              type="text"
              name="contacts[INDEX][name]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">職稱</label>
            <input
              type="text"
              name="contacts[INDEX][title]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input
              type="email"
              name="contacts[INDEX][email]"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">電話</label>
            <input
              type="tel"
              name="contacts[INDEX][phone]"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
        </div>
        <button
          type="button"
          class="remove-contact mt-4 px-3 py-1 text-red-600 hover:text-red-800"
        >
          刪除聯絡人
        </button>
      </div>
    </template>

    <script>
      let resourceCount = 0;
      let contactCount = 0;
      let countries = {};
      let isEditMode = false;

      // 處理內容類型變更
      function handleTypeChange(select) {
        const form = select.closest(".resource-form");
        const urlField = form.querySelector(".url-field");
        const urlInput = urlField.querySelector("input");

        if (select.value === "link") {
          urlField.style.display = "block";
          urlInput.required = true;
        } else {
          urlField.style.display = select.value === "text" ? "none" : "block";
          urlInput.required = false;
        }
      }

      async function initializeCountries() {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch("/api/partners/utils/countries", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("無法獲取國家列表");
          }

          countries = await response.json();
          const select = document.getElementById("countrySelect");
          select.innerHTML = '<option value="">請選擇國家</option>';

          Object.entries(countries).forEach(([code, data]) => {
            const option = document.createElement("option");
            option.value = code;
            option.textContent = `${data.flag} ${data.name}`;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("載入國家列表失敗:", error);
          alert("無法載入國家列表，請重新整理頁面或聯繫管理員");
        }
      }

      function addResource() {
        const template = document.getElementById("resourceTemplate");
        const container = document.getElementById("resourcesContainer");
        const clone = template.content.cloneNode(true);

        clone.querySelectorAll('[name*="INDEX"]').forEach((input) => {
          input.name = input.name.replace("INDEX", resourceCount);
        });

        container.appendChild(clone);
        resourceCount++;
      }

      function addContact() {
        const template = document.getElementById("contactTemplate");
        const container = document.getElementById("contactsContainer");
        const clone = template.content.cloneNode(true);

        clone.querySelectorAll('[name*="INDEX"]').forEach((input) => {
          input.name = input.name.replace("INDEX", contactCount);
        });

        container.appendChild(clone);
        contactCount++;
      }

      async function handleSubmit(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const urlParams = new URLSearchParams(window.location.search);
        const partnerId = urlParams.get("id");

        // 如果是編輯模式，保留原有的 timeline
        let timeline = [];
        if (partnerId) {
          const existingData = await fetch(`/api/partners/${partnerId}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          }).then((r) => r.json());
          timeline = existingData.timeline || [];
        }

        const data = {
          country: {
            code: formData.get("country"),
            name: countries[formData.get("country")]?.name,
            flag: countries[formData.get("country")]?.flag,
          },
          institution: {
            name: formData.get("institution"),
            department: formData.get("department"),
          },
          project: {
            subProject: formData.get("projectName"), // 映射到 subProject
            name: formData.get("project.name"), // 自訂合作項目名稱
            content: formData.get("project.content"),
          },
          progress: {
            phase: formData.get("phase"),
            details: formData.get("progressDetails"),
            lastUpdate: new Date(),
          },
          timeline: timeline,
          resources: [],
          contacts: [],
        };

        // 基本資料驗證
        if (!data.country.code || !data.country.name || !data.country.flag) {
          alert("請選擇國家");
          return;
        }

        if (!data.institution.name) {
          alert("請輸入機構名稱");
          return;
        }

        if (!data.project.subProject) {
          // 檢查 subProject
          alert("請選擇主責子計畫");
          return;
        }

        if (!data.project.name) {
          // 檢查自訂合作項目名稱
          alert("請輸入合作項目名稱");
          return;
        }

        if (!data.progress.phase) {
          alert("請選擇執行階段");
          return;
        }

        // 收集資源資訊
        for (let i = 0; i < resourceCount; i++) {
          const resourceTitle = formData.get(`resources[${i}][title]`);
          if (resourceTitle) {
            const resource = {
              title: resourceTitle,
              type: formData.get(`resources[${i}][type]`),
              content: formData.get(`resources[${i}][content]`),
              url: formData.get(`resources[${i}][url]`),
            };

            if (!resource.content) {
              alert(`請完整填寫資料區塊 "${resourceTitle}" 的內容`);
              return;
            }

            data.resources.push(resource);
          }
        }

        // 收集聯絡人資訊
        for (let i = 0; i < contactCount; i++) {
          const contactName = formData.get(`contacts[${i}][name]`);
          if (contactName) {
            const contact = {
              name: contactName,
              title: formData.get(`contacts[${i}][title]`),
              email: formData.get(`contacts[${i}][email]`),
              phone: formData.get(`contacts[${i}][phone]`),
            };

            if (!contact.title || !contact.email) {
              alert(`請完整填寫聯絡人 "${contactName}" 的所有必填資訊`);
              return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(contact.email)) {
              alert(`聯絡人 "${contactName}" 的 Email 格式不正確`);
              return;
            }

            data.contacts.push(contact);
          }
        }

        try {
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("未登入狀態");
          }

          const url = partnerId
            ? `/api/partners/${partnerId}`
            : "/api/partners";
          const method = partnerId ? "PUT" : "POST";

          const response = await fetch(url, {
            method: method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(data),
          });

          const responseData = await response.json();

          if (!response.ok) {
            throw new Error(responseData.message || "儲存失敗");
          }

          alert("儲存成功！");
          window.location.href = partnerId
            ? `/partner-detail.html?id=${partnerId}`
            : "/partners.html";
        } catch (error) {
          console.error("Error details:", error);
          alert(`儲存失敗: ${error.message}`);
        }
      }

      async function handleDelete() {
        const urlParams = new URLSearchParams(window.location.search);
        const partnerId = urlParams.get("id");

        if (!partnerId) return;

        if (!confirm("確定要刪除此合作夥伴嗎？此操作無法復原。")) {
          return;
        }

        try {
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("未登入狀態");
          }

          const response = await fetch(`/api/partners/${partnerId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.message || "刪除失敗");
          }

          alert("已成功刪除合作夥伴");
          window.location.href = "/partners.html";
        } catch (error) {
          console.error("Error details:", error);
          alert(`刪除失敗: ${error.message}`);
        }
      }

      function populateForm(data) {
        // 清空現有的資源和聯絡人容器
        document.getElementById("resourcesContainer").innerHTML = "";
        document.getElementById("contactsContainer").innerHTML = "";

        resourceCount = 0;
        contactCount = 0;

        // 基本資訊填充
        const countrySelect = document.querySelector('[name="country"]');
        if (countrySelect) {
          countrySelect.value = data.country.code;
        }

        const institutionInput = document.querySelector('[name="institution"]');
        if (institutionInput) {
          institutionInput.value = data.institution.name;
        }

        const departmentInput = document.querySelector('[name="department"]');
        if (departmentInput) {
          departmentInput.value = data.institution.department || "";
        }

        const projectNameInput = document.querySelector(
          '[name="project.name"]'
        );
        if (projectNameInput) {
          projectNameInput.value = data.project.name || "";
        }

        const projectContentInput = document.querySelector(
          '[name="project.content"]'
        );
        if (projectContentInput) {
          projectContentInput.value = data.project.content || "";
        }

        const phaseSelect = document.querySelector('[name="phase"]');
        if (phaseSelect) {
          phaseSelect.value = data.progress.phase;
        }

        const progressDetailsInput = document.querySelector(
          '[name="progressDetails"]'
        );
        if (progressDetailsInput) {
          progressDetailsInput.value = data.progress.details || "";
        }

        // 資源資料填充
        if (data.resources && data.resources.length > 0) {
          data.resources.forEach((resource) => {
            addResource();
            const lastIndex = resourceCount - 1;

            const titleInput = document.querySelector(
              `[name="resources[${lastIndex}][title]"]`
            );
            const typeSelect = document.querySelector(
              `[name="resources[${lastIndex}][type]"]`
            );
            const contentInput = document.querySelector(
              `[name="resources[${lastIndex}][content]"]`
            );
            const urlInput = document.querySelector(
              `[name="resources[${lastIndex}][url]"]`
            );

            if (titleInput) titleInput.value = resource.title;
            if (typeSelect) typeSelect.value = resource.type;
            if (contentInput) contentInput.value = resource.content;
            if (urlInput && resource.url) urlInput.value = resource.url;

            // 觸發類型變更處理
            const typeElement = document.querySelector(
              `[name="resources[${lastIndex}][type]"]`
            );
            if (typeElement) {
              handleTypeChange(typeElement);
            }
          });
        }

        // 聯絡人資料填充
        if (data.contacts && data.contacts.length > 0) {
          data.contacts.forEach((contact) => {
            addContact();
            const lastIndex = contactCount - 1;

            const nameInput = document.querySelector(
              `[name="contacts[${lastIndex}][name]"]`
            );
            const titleInput = document.querySelector(
              `[name="contacts[${lastIndex}][title]"]`
            );
            const emailInput = document.querySelector(
              `[name="contacts[${lastIndex}][email]"]`
            );
            const phoneInput = document.querySelector(
              `[name="contacts[${lastIndex}][phone]"]`
            );

            if (nameInput) nameInput.value = contact.name;
            if (titleInput) titleInput.value = contact.title;
            if (emailInput) emailInput.value = contact.email;
            if (phoneInput) phoneInput.value = contact.phone || "";
          });
        }
      }

      async function checkPermissions() {
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const urlParams = new URLSearchParams(window.location.search);
        const partnerId = urlParams.get("id");

        if (!user || !user.role) {
          window.location.href = "/login.html";
          return;
        }

        if (user.role === "admin") {
          return;
        }

        try {
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("未登入狀態");
          }

          const response = await fetch(`/api/partners/${partnerId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("無法載入資料");
          }

          const partner = await response.json();
          const hasCountryPermission = (user.assignedCountries || []).includes(
            partner.country.code
          );
          if (!hasCountryPermission) {
            window.location.href = "/partners.html";
          }
        } catch (error) {
          console.error("權限檢查失敗:", error);
          window.location.href = "/partners.html";
        }
      }

      function updateBackLink(partnerId) {
        const backLink = document.querySelector(
          '.nav-item[href="/partners.html"]'
        );
        if (backLink) {
          if (partnerId) {
            backLink.href = `/partner-detail.html?id=${partnerId}`;
            backLink.textContent = "返回詳細資料";
          } else {
            backLink.href = "/partners.html";
            backLink.textContent = "返回列表";
          }
        }
      }

      async function loadExistingData() {
        const urlParams = new URLSearchParams(window.location.search);
        const partnerId = urlParams.get("id");

        if (partnerId) {
          document.getElementById("deleteBtn").style.display = "block";

          try {
            const token = localStorage.getItem("token");
            if (!token) {
              throw new Error("未登入狀態");
            }

            const response = await fetch(`/api/partners/${partnerId}`, {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            if (!response.ok) {
              throw new Error("無法載入資料");
            }

            const data = await response.json();
            if (!data) {
              throw new Error("資料格式錯誤");
            }

            populateForm(data);
          } catch (error) {
            console.error("載入資料失敗:", error);
            alert(`載入失敗: ${error.message}`);
          }
        }
      }

      function setupEventListeners() {
        const form = document.getElementById("partnerForm");
        if (form) {
          form.addEventListener("submit", handleSubmit);
        }

        const addResourceBtn = document.getElementById("addResourceBtn");
        const addContactBtn = document.getElementById("addContactBtn");
        const deleteBtn = document.getElementById("deleteBtn");

        if (addResourceBtn)
          addResourceBtn.addEventListener("click", addResource);
        if (addContactBtn) addContactBtn.addEventListener("click", addContact);
        if (deleteBtn) deleteBtn.addEventListener("click", handleDelete);

        document.addEventListener("click", (event) => {
          if (event.target.classList.contains("remove-resource")) {
            const resourceForm = event.target.closest(".resource-form");
            if (resourceForm && confirm("確定要刪除此資料區塊嗎？")) {
              resourceForm.remove();
            }
          } else if (event.target.classList.contains("remove-contact")) {
            const contactForm = event.target.closest(".contact-form");
            if (contactForm && confirm("確定要刪除此聯絡人嗎？")) {
              contactForm.remove();
            }
          }
        });
      }

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          await checkPermissions();
          await initializeCountries();
          setupEventListeners();

          const urlParams = new URLSearchParams(window.location.search);
          const partnerId = urlParams.get("id");
          updateBackLink(partnerId);
          await loadExistingData();
        } catch (error) {
          console.error("初始化失敗:", error);
          alert("頁面初始化失敗，請重新整理或聯繫管理員");
        }
      });
    </script>
  </body>
</html>
